# ğŸ—ï¸ Arquitectura del Sistema Completa

## Secure Video Streaming Platform
### Sistema de Streaming de Video con CriptografÃ­a de Grado Militar

**Fecha de ActualizaciÃ³n:** Diciembre 7, 2025  
**VersiÃ³n:** 3.0 - Sistema Completo  
**Estado:** âœ… ProducciÃ³n

---

## ğŸ“Š Vista General del Sistema

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    ğŸ¬ SECURE VIDEO STREAMING PLATFORM                             â•‘
â•‘              Sistema de DistribuciÃ³n de Video con Seguridad Multi-Capa           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ                          ğŸ‘¥ TIPOS DE USUARIOS                                   â”ƒ
â”£â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”«
â”ƒ                                                                                 â”ƒ
â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”ƒ
â”ƒ  â”‚   ğŸ‘¨â€ğŸ’¼ ADMINISTRADOR      â”‚              â”‚   ğŸ‘¤ USUARIO CONSUMIDOR â”‚            â”ƒ
â”ƒ  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”ƒ
â”ƒ  â”‚ â€¢ Subir videos         â”‚              â”‚ â€¢ Visualizar videos    â”‚            â”ƒ
â”ƒ  â”‚ â€¢ Cifrar contenido     â”‚              â”‚ â€¢ Solicitar acceso     â”‚            â”ƒ
â”ƒ  â”‚ â€¢ Gestionar permisos   â”‚              â”‚ â€¢ Reproducir contenido â”‚            â”ƒ
â”ƒ  â”‚ â€¢ Verificar integridad â”‚              â”‚ â€¢ Ver mis permisos     â”‚            â”ƒ
â”ƒ  â”‚ â€¢ Revocar accesos      â”‚              â”‚ â€¢ Descargar autorizado â”‚            â”ƒ
â”ƒ  â”‚ â€¢ Monitorear accesos   â”‚              â”‚ â€¢ Verificar integridad â”‚            â”ƒ
â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”ƒ
â”ƒ           â”‚                                        â”‚                            â”ƒ
â”ƒ           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”¿â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
                             â”‚
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â–¼â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ                     ğŸŒ CAPA DE PRESENTACIÃ“N (ASP.NET Core 8.0)                 â”ƒ
â”£â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”«
â”ƒ                                                                                 â”ƒ
â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”ƒ
â”ƒ  â”‚   ğŸ”Œ API REST CONTROLLERS    â”‚    â”‚   ğŸ“„ RAZOR PAGES             â”‚         â”ƒ
â”ƒ  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”ƒ
â”ƒ  â”‚                              â”‚    â”‚                              â”‚         â”ƒ
â”ƒ  â”‚ ğŸ” AuthController            â”‚    â”‚ ğŸ  Home.cshtml               â”‚         â”ƒ
â”ƒ  â”‚   â€¢ POST /register           â”‚    â”‚   â€¢ Dashboard principal      â”‚         â”ƒ
â”ƒ  â”‚   â€¢ POST /login              â”‚â—„â”€â”€â”€â”¤   â€¢ EstadÃ­sticas por rol     â”‚         â”ƒ
â”ƒ  â”‚   â€¢ GET  /me                 â”‚    â”‚   â€¢ Videos segÃºn permisos    â”‚         â”ƒ
â”ƒ  â”‚                              â”‚    â”‚                              â”‚         â”ƒ
â”ƒ  â”‚ ğŸ‘¥ UsersController           â”‚    â”‚ ğŸ”‘ Login/Register.cshtml     â”‚         â”ƒ
â”ƒ  â”‚   â€¢ GET  /users              â”‚    â”‚   â€¢ AutenticaciÃ³n sesiÃ³n     â”‚         â”ƒ
â”ƒ  â”‚   â€¢ GET  /users/{id}         â”‚    â”‚   â€¢ GeneraciÃ³n claves RSA    â”‚         â”ƒ
â”ƒ  â”‚   â€¢ PUT  /users/{id}         â”‚    â”‚                              â”‚         â”ƒ
â”ƒ  â”‚   â€¢ DELETE /users/{id}       â”‚    â”‚ ğŸ“¤ UploadVideo.cshtml        â”‚         â”ƒ
â”ƒ  â”‚                              â”‚    â”‚   â€¢ Subida archivos          â”‚         â”ƒ
â”ƒ  â”‚ ğŸ¥ VideosController          â”‚    â”‚   â€¢ Preview pre-cifrado      â”‚         â”ƒ
â”ƒ  â”‚   â€¢ POST /upload             â”‚â—„â”€â”€â”€â”¤   â€¢ Progress tracking        â”‚         â”ƒ
â”ƒ  â”‚   â€¢ GET  /my-videos          â”‚    â”‚                              â”‚         â”ƒ
â”ƒ  â”‚   â€¢ GET  /{id}               â”‚    â”‚ ğŸ“¹ VideoPlayer.cshtml        â”‚         â”ƒ
â”ƒ  â”‚   â€¢ POST /{id}/verify        â”‚    â”‚   â€¢ Reproductor embebido     â”‚         â”ƒ
â”ƒ  â”‚   â€¢ DELETE /{id}             â”‚    â”‚   â€¢ Control de permisos      â”‚         â”ƒ
â”ƒ  â”‚                              â”‚    â”‚   â€¢ Descifrado cliente-lado  â”‚         â”ƒ
â”ƒ  â”‚ ğŸ”“ PermissionsController     â”‚    â”‚                              â”‚         â”ƒ
â”ƒ  â”‚   â€¢ POST /grant              â”‚    â”‚ ğŸ¬ MyVideos.cshtml           â”‚         â”ƒ
â”ƒ  â”‚   â€¢ DELETE /{id}             â”‚    â”‚   â€¢ Lista videos admin       â”‚         â”ƒ
â”ƒ  â”‚   â€¢ GET  /check              â”‚    â”‚   â€¢ Modal reproductor        â”‚         â”ƒ
â”ƒ  â”‚   â€¢ GET  /video/{videoId}    â”‚â—„â”€â”€â”€â”¤   â€¢ Lista usuarios acceso    â”‚         â”ƒ
â”ƒ  â”‚   â€¢ GET  /my-permissions     â”‚    â”‚                              â”‚         â”ƒ
â”ƒ  â”‚   â€¢ PUT  /{id}/extend        â”‚    â”‚ ğŸ—‚ï¸ VideoGrid.cshtml          â”‚         â”ƒ
â”ƒ  â”‚                              â”‚    â”‚   â€¢ CatÃ¡logo de videos       â”‚         â”ƒ
â”ƒ  â”‚ ğŸ”‘ KeyDistributionController â”‚    â”‚   â€¢ Filtros y bÃºsqueda       â”‚         â”ƒ
â”ƒ  â”‚   â€¢ POST /get-key            â”‚â—„â”€â”€â”€â”¤   â€¢ Vista grid/lista         â”‚         â”ƒ
â”ƒ  â”‚   â€¢ GET  /request-access     â”‚    â”‚                              â”‚         â”ƒ
â”ƒ  â”‚                              â”‚    â”‚ ğŸ›¡ï¸ ManagePermissions.cshtml  â”‚         â”ƒ
â”ƒ  â”‚ ğŸŒŠ StreamingController       â”‚    â”‚   â€¢ Otorgar permisos         â”‚         â”ƒ
â”ƒ  â”‚   â€¢ GET  /video/{id}         â”‚    â”‚   â€¢ Revocar accesos          â”‚         â”ƒ
â”ƒ  â”‚   â€¢ Range Request Support    â”‚    â”‚   â€¢ Extender expiraciÃ³n      â”‚         â”ƒ
â”ƒ  â”‚                              â”‚    â”‚                              â”‚         â”ƒ
â”ƒ  â”‚ ğŸï¸ VideoGridController       â”‚    â”‚ âœ… IntegrityCheck.cshtml     â”‚         â”ƒ
â”ƒ  â”‚   â€¢ GET  /                   â”‚    â”‚   â€¢ Verificar SHA-256        â”‚         â”ƒ
â”ƒ  â”‚   â€¢ GET  /search             â”‚    â”‚   â€¢ Validar HMAC-SHA256      â”‚         â”ƒ
â”ƒ  â”‚   â€¢ GET  /{id}               â”‚    â”‚   â€¢ Estado ChaCha20-Poly1305 â”‚         â”ƒ
â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”ƒ
â”ƒ           â”‚                                    â”‚                                â”ƒ
â”ƒ           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”ƒ
â”ƒ                     â”‚                                                            â”ƒ
â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”ƒ
â”ƒ  â”‚  ğŸ›¡ï¸ MIDDLEWARE PIPELINE                                     â”‚                â”ƒ
â”ƒ  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”ƒ
â”ƒ  â”‚  â€¢ Session Management (Cookie-based)                       â”‚                â”ƒ
â”ƒ  â”‚  â€¢ JWT Authentication (Bearer Token)                       â”‚                â”ƒ
â”ƒ  â”‚  â€¢ Role-Based Authorization [Administrador/Usuario]        â”‚                â”ƒ
â”ƒ  â”‚  â€¢ Error Handling & Logging                                â”‚                â”ƒ
â”ƒ  â”‚  â€¢ CORS Policy                                             â”‚                â”ƒ
â”ƒ  â”‚  â€¢ Anti-Forgery Token Validation                           â”‚                â”ƒ
â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”¯â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
                               â”‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â–¼â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ                      ğŸ’¼ CAPA DE LÃ“GICA DE NEGOCIO                              â”ƒ
â”ƒ                  (SecureVideoStreaming.Services.Business)                      â”ƒ
â”£â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”«
â”ƒ                                                                                 â”ƒ
â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”ƒ
â”ƒ  â”‚                    ğŸ” SERVICIOS DE AUTENTICACIÃ“N Y USUARIOS              â”‚  â”ƒ
â”ƒ  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”ƒ
â”ƒ  â”‚                                                                          â”‚  â”ƒ
â”ƒ  â”‚  AuthService                          UserService                       â”‚  â”ƒ
â”ƒ  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                       â”‚  â”ƒ
â”ƒ  â”‚  â€¢ RegisterAsync()                    â€¢ GetByIdAsync()                  â”‚  â”ƒ
â”ƒ  â”‚    â”œâ”€ Validar email Ãºnico             â€¢ GetAllUsersAsync()              â”‚  â”ƒ
â”ƒ  â”‚    â”œâ”€ Generar Salt (128 bits)         â€¢ UpdateUserAsync()               â”‚  â”ƒ
â”ƒ  â”‚    â”œâ”€ PBKDF2-SHA256 (100K iter.)      â€¢ DeleteUserAsync()               â”‚  â”ƒ
â”ƒ  â”‚    â”œâ”€ Validar RSA public key          â€¢ GetByEmailAsync()               â”‚  â”ƒ
â”ƒ  â”‚    â””â”€ Generar HMAC-SHA256 key         â€¢ ActivateUserAsync()             â”‚  â”ƒ
â”ƒ  â”‚                                        â€¢ DeactivateUserAsync()           â”‚  â”ƒ
â”ƒ  â”‚  â€¢ LoginAsync()                                                          â”‚  â”ƒ
â”ƒ  â”‚    â”œâ”€ Buscar usuario por email                                          â”‚  â”ƒ
â”ƒ  â”‚    â”œâ”€ Verificar PBKDF2 hash                                             â”‚  â”ƒ
â”ƒ  â”‚    â”œâ”€ Generar JWT (exp: 24h)                                            â”‚  â”ƒ
â”ƒ  â”‚    â””â”€ Actualizar UltimoAcceso                                           â”‚  â”ƒ
â”ƒ  â”‚                                                                          â”‚  â”ƒ
â”ƒ  â”‚  â€¢ GetCurrentUserAsync()                                                â”‚  â”ƒ
â”ƒ  â”‚  â€¢ GenerateJwtToken()                                                   â”‚  â”ƒ
â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”ƒ
â”ƒ                                                                                 â”ƒ
â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”ƒ
â”ƒ  â”‚                    ğŸ¥ SERVICIOS DE GESTIÃ“N DE VIDEOS                     â”‚  â”ƒ
â”ƒ  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”ƒ
â”ƒ  â”‚                                                                          â”‚  â”ƒ
â”ƒ  â”‚  VideoService                         VideoGridService                  â”‚  â”ƒ
â”ƒ  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â”‚  â”ƒ
â”ƒ  â”‚  â€¢ UploadVideoAsync()                 â€¢ GetAllVideosAsync()             â”‚  â”ƒ
â”ƒ  â”‚    â”œâ”€ Validar admin role              â€¢ GetVideoByIdAsync()             â”‚  â”ƒ
â”ƒ  â”‚    â”œâ”€ Guardar temp file               â€¢ SearchVideosAsync()             â”‚  â”ƒ
â”ƒ  â”‚    â”œâ”€ Invocar VideoEncryption         â€¢ FilterByAdminAsync()            â”‚  â”ƒ
â”ƒ  â”‚    â”œâ”€ Guardar CryptoData              â€¢ GetVideosWithPermissionsAsync() â”‚  â”ƒ
â”ƒ  â”‚    â””â”€ Eliminar archivo temp           â€¢ GetVideoDetailsAsync()          â”‚  â”ƒ
â”ƒ  â”‚                                                                          â”‚  â”ƒ
â”ƒ  â”‚  â€¢ GetVideosByAdminAsync()            VideoStreamingService             â”‚  â”ƒ
â”ƒ  â”‚  â€¢ GetAllVideosAsync()                â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”‚  â”ƒ
â”ƒ  â”‚  â€¢ GetVideoByIdAsync()                â€¢ GetVideoStreamAsync()           â”‚  â”ƒ
â”ƒ  â”‚  â€¢ VerifyIntegrityAsync()             â€¢ ValidateAccessAsync()           â”‚  â”ƒ
â”ƒ  â”‚    â”œâ”€ Validar SHA-256                 â€¢ GetChunkAsync()                 â”‚  â”ƒ
â”ƒ  â”‚    â”œâ”€ Validar HMAC-SHA256             â€¢ SupportRangeRequests()          â”‚  â”ƒ
â”ƒ  â”‚    â””â”€ Validar Poly1305 AuthTag                                          â”‚  â”ƒ
â”ƒ  â”‚                                                                          â”‚  â”ƒ
â”ƒ  â”‚  â€¢ UpdateMetadataAsync()                                                â”‚  â”ƒ
â”ƒ  â”‚  â€¢ DeleteVideoAsync()                                                   â”‚  â”ƒ
â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”ƒ
â”ƒ                                                                                 â”ƒ
â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”ƒ
â”ƒ  â”‚              ğŸ”“ SERVICIOS DE PERMISOS Y DISTRIBUCIÃ“N DE CLAVES           â”‚  â”ƒ
â”ƒ  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”ƒ
â”ƒ  â”‚                                                                          â”‚  â”ƒ
â”ƒ  â”‚  PermissionService                    KeyDistributionService            â”‚  â”ƒ
â”ƒ  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚  â”ƒ
â”ƒ  â”‚  â€¢ GrantPermissionAsync()             â€¢ GetKeyPackageAsync()            â”‚  â”ƒ
â”ƒ  â”‚    â”œâ”€ Validar ownership                 â”œâ”€ Verificar permiso activo     â”‚  â”ƒ
â”ƒ  â”‚    â”œâ”€ Verificar duplicados              â”œâ”€ Omitir si admin owner        â”‚  â”ƒ
â”ƒ  â”‚    â”œâ”€ Validar fechas                    â”œâ”€ Obtener CryptoData           â”‚  â”ƒ
â”ƒ  â”‚    â””â”€ Insertar registro                 â”œâ”€ Descifrar KEK (RSA servidor) â”‚  â”ƒ
â”ƒ  â”‚                                          â”œâ”€ Re-cifrar KEK (RSA usuario)  â”‚  â”ƒ
â”ƒ  â”‚  â€¢ RevokePermissionAsync()              â”œâ”€ Generar streaming token      â”‚  â”ƒ
â”ƒ  â”‚  â€¢ CheckPermissionAsync()               â”œâ”€ Incrementar contador         â”‚  â”ƒ
â”ƒ  â”‚  â€¢ HasAccessAsync()                     â””â”€ Registrar acceso             â”‚  â”ƒ
â”ƒ  â”‚  â€¢ GetPermissionsByVideoAsync()                                         â”‚  â”ƒ
â”ƒ  â”‚  â€¢ GetPermissionsByUserAsync()        â€¢ GenerateStreamingTokenAsync()   â”‚  â”ƒ
â”ƒ  â”‚  â€¢ ExtendPermissionAsync()            â€¢ ValidateStreamingTokenAsync()   â”‚  â”ƒ
â”ƒ  â”‚  â€¢ RequestAccessAsync()                                                 â”‚  â”ƒ
â”ƒ  â”‚  â€¢ ApprovePermissionAsync()                                             â”‚  â”ƒ
â”ƒ  â”‚  â€¢ RegisterAccessAsync()                                                â”‚  â”ƒ
â”ƒ  â”‚  â€¢ IncrementAccessCountAsync()                                          â”‚  â”ƒ
â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”¯â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
                               â”‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â–¼â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ                      ğŸ” CAPA DE CRIPTOGRAFÃA                                   â”ƒ
â”ƒ                (SecureVideoStreaming.Services.Cryptography)                    â”ƒ
â”£â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”«
â”ƒ                                                                                 â”ƒ
â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”ƒ
â”ƒ  â”‚              ğŸ¯ SERVICIOS DE CIFRADO SIMÃ‰TRICO (AEAD)                    â”‚  â”ƒ
â”ƒ  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”ƒ
â”ƒ  â”‚                                                                          â”‚  â”ƒ
â”ƒ  â”‚  ChaCha20Poly1305Service         VideoEncryptionService                 â”‚  â”ƒ
â”ƒ  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                 â”‚  â”ƒ
â”ƒ  â”‚  Algoritmo: ChaCha20-Poly1305    Orquestador de cifrado de videos       â”‚  â”ƒ
â”ƒ  â”‚  Tipo: AEAD (Authenticated       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚  â”ƒ
â”ƒ  â”‚        Encryption with            â€¢ EncryptVideoAsync()                 â”‚  â”ƒ
â”ƒ  â”‚        Associated Data)             â”œâ”€ Leer video en chunks (80KB)      â”‚  â”ƒ
â”ƒ  â”‚                                     â”œâ”€ Calcular SHA-256 original        â”‚  â”ƒ
â”ƒ  â”‚  ParÃ¡metros:                        â”œâ”€ Generar KEK (32 bytes)           â”‚  â”ƒ
â”ƒ  â”‚  â€¢ Key: 256 bits (32 bytes)         â”œâ”€ Cifrar KEK con RSA-OAEP          â”‚  â”ƒ
â”ƒ  â”‚  â€¢ Nonce: 96 bits (12 bytes)        â”œâ”€ Generar Nonce (12 bytes)         â”‚  â”ƒ
â”ƒ  â”‚  â€¢ AuthTag: 128 bits (16 bytes)     â”œâ”€ Cifrar con ChaCha20-Poly1305     â”‚  â”ƒ
â”ƒ  â”‚                                     â”œâ”€ Obtener AuthTag (16 bytes)       â”‚  â”ƒ
â”ƒ  â”‚  MÃ©todos:                           â”œâ”€ Calcular HMAC del cifrado        â”‚  â”ƒ
â”ƒ  â”‚  â€¢ Encrypt(plaintext, key, nonce)   â””â”€ Guardar {guid}.encrypted         â”‚  â”ƒ
â”ƒ  â”‚    â””â”€> (ciphertext, authTag)                                            â”‚  â”ƒ
â”ƒ  â”‚                                   â€¢ DecryptVideoAsync()                  â”‚  â”ƒ
â”ƒ  â”‚  â€¢ Decrypt(ciphertext, key,       â€¢ VerifyIntegrityAsync()              â”‚  â”ƒ
â”ƒ  â”‚           nonce, authTag)           â”œâ”€ Validar SHA-256 original          â”‚  â”ƒ
â”ƒ  â”‚    â””â”€> plaintext                    â”œâ”€ Validar HMAC-SHA256 cifrado      â”‚  â”ƒ
â”ƒ  â”‚                                     â””â”€ Validar Poly1305 AuthTag         â”‚  â”ƒ
â”ƒ  â”‚  â€¢ GenerateKey()                                                         â”‚  â”ƒ
â”ƒ  â”‚    â””â”€> 32 random bytes            â€¢ CalculateFileHashAsync()            â”‚  â”ƒ
â”ƒ  â”‚                                                                          â”‚  â”ƒ
â”ƒ  â”‚  â€¢ GenerateNonce()                                                       â”‚  â”ƒ
â”ƒ  â”‚    â””â”€> 12 random bytes                                                  â”‚  â”ƒ
â”ƒ  â”‚                                                                          â”‚  â”ƒ
â”ƒ  â”‚  Seguridad:                                                              â”‚  â”ƒ
â”ƒ  â”‚  âœ… Resistente a ataques de canal lateral                               â”‚  â”ƒ
â”ƒ  â”‚  âœ… AutenticaciÃ³n integrada (AEAD)                                      â”‚  â”ƒ
â”ƒ  â”‚  âœ… Mismo nivel que TLS 1.3                                             â”‚  â”ƒ
â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”ƒ
â”ƒ                                                                                 â”ƒ
â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”ƒ
â”ƒ  â”‚              ğŸ”‘ SERVICIOS DE CIFRADO ASIMÃ‰TRICO                          â”‚  â”ƒ
â”ƒ  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”ƒ
â”ƒ  â”‚                                                                          â”‚  â”ƒ
â”ƒ  â”‚  RsaService                          KekService                         â”‚  â”ƒ
â”ƒ  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                         â”‚  â”ƒ
â”ƒ  â”‚  Algoritmo: RSA-4096                 GestiÃ³n de KEK (Key Encryption Key)â”‚  â”ƒ
â”ƒ  â”‚  Padding: OAEP-SHA256                â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚  â”ƒ
â”ƒ  â”‚  Formato: PEM                        â€¢ GenerateKek()                    â”‚  â”ƒ
â”ƒ  â”‚                                        â””â”€> 32 random bytes               â”‚  â”ƒ
â”ƒ  â”‚  MÃ©todos:                                                                â”‚  â”ƒ
â”ƒ  â”‚  â€¢ GenerateKeyPair(4096)           â€¢ EncryptKek(kek, publicKey)         â”‚  â”ƒ
â”ƒ  â”‚    â””â”€> (publicKey, privateKey)       â””â”€> RSA-OAEP encrypted KEK         â”‚  â”ƒ
â”ƒ  â”‚                                                                          â”‚  â”ƒ
â”ƒ  â”‚  â€¢ Encrypt(data, publicKey)        â€¢ DecryptKek(encKek, privateKey)     â”‚  â”ƒ
â”ƒ  â”‚    â””â”€> RSA-OAEP ciphertext           â””â”€> KEK plaintext                  â”‚  â”ƒ
â”ƒ  â”‚                                                                          â”‚  â”ƒ
â”ƒ  â”‚  â€¢ Decrypt(cipher, privateKey)     â€¢ GenerateAndEncryptKek(pubKey)      â”‚  â”ƒ
â”ƒ  â”‚    â””â”€> plaintext                     â””â”€> (kek, encryptedKek)            â”‚  â”ƒ
â”ƒ  â”‚                                                                          â”‚  â”ƒ
â”ƒ  â”‚  â€¢ ExportPublicKey()                                                     â”‚  â”ƒ
â”ƒ  â”‚  â€¢ ExportPrivateKey()                                                    â”‚  â”ƒ
â”ƒ  â”‚  â€¢ ImportPublicKey(pemString)                                            â”‚  â”ƒ
â”ƒ  â”‚  â€¢ ImportPrivateKey(pemString)                                           â”‚  â”ƒ
â”ƒ  â”‚                                                                          â”‚  â”ƒ
â”ƒ  â”‚  KeyManagementService              PrivateKeyEncryptionService          â”‚  â”ƒ
â”ƒ  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚  â”ƒ
â”ƒ  â”‚  GestiÃ³n de claves del servidor    Cifrado de claves privadas           â”‚  â”ƒ
â”ƒ  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚  â”ƒ
â”ƒ  â”‚  â€¢ GetServerPublicKey()            â€¢ EncryptPrivateKey()                â”‚  â”ƒ
â”ƒ  â”‚  â€¢ GetServerPrivateKey()             â”œâ”€ PBKDF2 con master secret        â”‚  â”ƒ
â”ƒ  â”‚  â€¢ GenerateServerKeys()              â”œâ”€ ChaCha20-Poly1305               â”‚  â”ƒ
â”ƒ  â”‚  â€¢ SaveServerKeys()                  â””â”€> Encrypted PEM                  â”‚  â”ƒ
â”ƒ  â”‚  â€¢ DeriveHmacKey()                                                       â”‚  â”ƒ
â”ƒ  â”‚  â€¢ ValidateKeys()                  â€¢ DecryptPrivateKey()                â”‚  â”ƒ
â”ƒ  â”‚                                                                          â”‚  â”ƒ
â”ƒ  â”‚  Archivos:                                                               â”‚  â”ƒ
â”ƒ  â”‚  ğŸ“ Storage/Keys/                                                        â”‚  â”ƒ
â”ƒ  â”‚     â”œâ”€ server_public_key.pem                                            â”‚  â”ƒ
â”ƒ  â”‚     â”œâ”€ server_private_key.pem                                           â”‚  â”ƒ
â”ƒ  â”‚     â””â”€ .master_secret                                                   â”‚  â”ƒ
â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”ƒ
â”ƒ                                                                                 â”ƒ
â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”ƒ
â”ƒ  â”‚              ğŸ” SERVICIOS DE HASH Y AUTENTICACIÃ“N                        â”‚  â”ƒ
â”ƒ  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”ƒ
â”ƒ  â”‚                                                                          â”‚  â”ƒ
â”ƒ  â”‚  HashService                         HmacService                        â”‚  â”ƒ
â”ƒ  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                        â”‚  â”ƒ
â”ƒ  â”‚  Algoritmo: SHA-256                  Algoritmo: HMAC-SHA256             â”‚  â”ƒ
â”ƒ  â”‚  Uso: Integridad + Password          Uso: AutenticaciÃ³n de mensajes     â”‚  â”ƒ
â”ƒ  â”‚                                                                          â”‚  â”ƒ
â”ƒ  â”‚  MÃ©todos:                            ParÃ¡metros:                         â”‚  â”ƒ
â”ƒ  â”‚  â€¢ ComputeSha256(data)               â€¢ Key: 64 bytes (recomendado)      â”‚  â”ƒ
â”ƒ  â”‚    â””â”€> 32 bytes hash                 â€¢ Output: 32 bytes                 â”‚  â”ƒ
â”ƒ  â”‚                                                                          â”‚  â”ƒ
â”ƒ  â”‚  â€¢ ComputeSha256Stream(stream)       MÃ©todos:                            â”‚  â”ƒ
â”ƒ  â”‚    â””â”€> Hash de archivos grandes      â€¢ ComputeHmac(data, key)           â”‚  â”ƒ
â”ƒ  â”‚                                        â””â”€> 32 bytes HMAC                â”‚  â”ƒ
â”ƒ  â”‚  â€¢ VerifyHash(data, hash)                                               â”‚  â”ƒ
â”ƒ  â”‚    â””â”€> bool (constant-time)         â€¢ VerifyHmac(data, hmac, key)       â”‚  â”ƒ
â”ƒ  â”‚                                        â””â”€> bool (constant-time)         â”‚  â”ƒ
â”ƒ  â”‚  â€¢ HashPassword(password, salt)                                         â”‚  â”ƒ
â”ƒ  â”‚    â”œâ”€ PBKDF2-SHA256                 â€¢ GenerateKey()                     â”‚  â”ƒ
â”ƒ  â”‚    â”œâ”€ 100,000 iteraciones             â””â”€> 64 random bytes               â”‚  â”ƒ
â”ƒ  â”‚    â””â”€> 32 bytes hash                                                    â”‚  â”ƒ
â”ƒ  â”‚                                                                          â”‚  â”ƒ
â”ƒ  â”‚  â€¢ VerifyPassword(pwd, hash, salt)   KmacService                        â”‚  â”ƒ
â”ƒ  â”‚    â””â”€> bool                          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                       â”‚  â”ƒ
â”ƒ  â”‚                                      Algoritmo: KMAC256 (SHA-3 based)   â”‚  â”ƒ
â”ƒ  â”‚  â€¢ GenerateSalt()                    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”ƒ
â”ƒ  â”‚    â””â”€> 16 bytes                      â€¢ ComputeKmac256()                 â”‚  â”ƒ
â”ƒ  â”‚                                      â€¢ VerifyKmac256()                   â”‚  â”ƒ
â”ƒ  â”‚  â€¢ DeriveKey(password, salt)         â€¢ GenerateKey()                    â”‚  â”ƒ
â”ƒ  â”‚    â””â”€> PBKDF2 derivation                                                â”‚  â”ƒ
â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”¯â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
                               â”‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â–¼â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ                      ğŸ’¾ CAPA DE ACCESO A DATOS                                 â”ƒ
â”ƒ              (SecureVideoStreaming.Data - Entity Framework Core 8.0)           â”ƒ
â”£â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”«
â”ƒ                                                                                 â”ƒ
â”ƒ  ApplicationDbContext                                                           â”ƒ
â”ƒ  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                          â”ƒ
â”ƒ                                                                                 â”ƒ
â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”ƒ
â”ƒ  â”‚  DbSet<User> Usuarios                                                    â”‚  â”ƒ
â”ƒ  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”ƒ
â”ƒ  â”‚  Tabla: Usuarios                                                         â”‚  â”ƒ
â”ƒ  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                        â”‚  â”ƒ
â”ƒ  â”‚  Campos:                                                                 â”‚  â”ƒ
â”ƒ  â”‚  â€¢ IdUsuario (PK, Identity)                                              â”‚  â”ƒ
â”ƒ  â”‚  â€¢ NombreUsuario (nvarchar(100), unique)                                 â”‚  â”ƒ
â”ƒ  â”‚  â€¢ Email (nvarchar(255), unique, index)                                  â”‚  â”ƒ
â”ƒ  â”‚  â€¢ TipoUsuario (nvarchar(50)) â†’ 'Administrador' | 'Usuario'             â”‚  â”ƒ
â”ƒ  â”‚  â€¢ PasswordHash (varbinary(MAX)) â†’ PBKDF2-SHA256                         â”‚  â”ƒ
â”ƒ  â”‚  â€¢ Salt (varbinary(128))                                                 â”‚  â”ƒ
â”ƒ  â”‚  â€¢ ClavePublicaRSA (nvarchar(MAX)) â†’ PEM format                          â”‚  â”ƒ
â”ƒ  â”‚  â€¢ PublicKeyFingerprint (nvarchar(64))                                   â”‚  â”ƒ
â”ƒ  â”‚  â€¢ FechaRegistro (datetime2)                                             â”‚  â”ƒ
â”ƒ  â”‚  â€¢ UltimoAcceso (datetime2, nullable)                                    â”‚  â”ƒ
â”ƒ  â”‚  â€¢ Activo (bit)                                                          â”‚  â”ƒ
â”ƒ  â”‚                                                                           â”‚  â”ƒ
â”ƒ  â”‚  Relaciones:                                                             â”‚  â”ƒ
â”ƒ  â”‚  â€¢ ClavesUsuarios (1:1)                                                  â”‚  â”ƒ
â”ƒ  â”‚  â€¢ VideosAdministrados (1:N)                                             â”‚  â”ƒ
â”ƒ  â”‚  â€¢ Permisos (1:N)                                                        â”‚  â”ƒ
â”ƒ  â”‚  â€¢ RegistrosAccesos (1:N)                                                â”‚  â”ƒ
â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”ƒ
â”ƒ                                                                                 â”ƒ
â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”ƒ
â”ƒ  â”‚  DbSet<UserKeys> ClavesUsuarios                                          â”‚  â”ƒ
â”ƒ  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”ƒ
â”ƒ  â”‚  Tabla: ClavesUsuarios                                                   â”‚  â”ƒ
â”ƒ  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                  â”‚  â”ƒ
â”ƒ  â”‚  Campos:                                                                 â”‚  â”ƒ
â”ƒ  â”‚  â€¢ IdClave (PK, Identity)                                                â”‚  â”ƒ
â”ƒ  â”‚  â€¢ IdUsuario (FK â†’ Usuarios.IdUsuario)                                   â”‚  â”ƒ
â”ƒ  â”‚  â€¢ ClaveHMAC (varbinary(64)) â†’ Para verificaciÃ³n de integridad           â”‚  â”ƒ
â”ƒ  â”‚  â€¢ AlgoritmoHMAC (nvarchar(50)) â†’ "HMAC-SHA256"                          â”‚  â”ƒ
â”ƒ  â”‚  â€¢ FechaGeneracion (datetime2)                                           â”‚  â”ƒ
â”ƒ  â”‚  â€¢ EstaActiva (bit)                                                      â”‚  â”ƒ
â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”ƒ
â”ƒ                                                                                 â”ƒ
â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”ƒ
â”ƒ  â”‚  DbSet<Video> Videos                                                     â”‚  â”ƒ
â”ƒ  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”ƒ
â”ƒ  â”‚  Tabla: Videos                                                           â”‚  â”ƒ
â”ƒ  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                          â”‚  â”ƒ
â”ƒ  â”‚  Campos:                                                                 â”‚  â”ƒ
â”ƒ  â”‚  â€¢ IdVideo (PK, Identity)                                                â”‚  â”ƒ
â”ƒ  â”‚  â€¢ IdAdministrador (FK â†’ Usuarios.IdUsuario)                             â”‚  â”ƒ
â”ƒ  â”‚  â€¢ TituloVideo (nvarchar(255))                                           â”‚  â”ƒ
â”ƒ  â”‚  â€¢ Descripcion (nvarchar(1000), nullable)                                â”‚  â”ƒ
â”ƒ  â”‚  â€¢ NombreArchivoOriginal (nvarchar(255))                                 â”‚  â”ƒ
â”ƒ  â”‚  â€¢ NombreArchivoCifrado (nvarchar(255)) â†’ {guid}.encrypted               â”‚  â”ƒ
â”ƒ  â”‚  â€¢ TamaÃ±oArchivo (bigint) â†’ bytes                                        â”‚  â”ƒ
â”ƒ  â”‚  â€¢ RutaAlmacenamiento (nvarchar(500)) â†’ Storage/Videos/{guid}.encrypted  â”‚  â”ƒ
â”ƒ  â”‚  â€¢ EstadoProcesamiento (nvarchar(50)) â†’ "Disponible" | "Procesando"     â”‚  â”ƒ
â”ƒ  â”‚  â€¢ FechaSubida (datetime2)                                               â”‚  â”ƒ
â”ƒ  â”‚  â€¢ FechaModificacion (datetime2, nullable)                               â”‚  â”ƒ
â”ƒ  â”‚                                                                           â”‚  â”ƒ
â”ƒ  â”‚  Relaciones:                                                             â”‚  â”ƒ
â”ƒ  â”‚  â€¢ Administrador (N:1 â†’ Usuario)                                         â”‚  â”ƒ
â”ƒ  â”‚  â€¢ DatosCriptograficos (1:1)                                             â”‚  â”ƒ
â”ƒ  â”‚  â€¢ Permisos (1:N)                                                        â”‚  â”ƒ
â”ƒ  â”‚  â€¢ RegistrosAccesos (1:N)                                                â”‚  â”ƒ
â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”ƒ
â”ƒ                                                                                 â”ƒ
â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”ƒ
â”ƒ  â”‚  DbSet<CryptoData> DatosCriptograficosVideos                             â”‚  â”ƒ
â”ƒ  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”ƒ
â”ƒ  â”‚  Tabla: DatosCriptograficosVideos                                        â”‚  â”ƒ
â”ƒ  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                      â”‚  â”ƒ
â”ƒ  â”‚  Campos:                                                                 â”‚  â”ƒ
â”ƒ  â”‚  â€¢ IdDatosCriptograficos (PK, Identity)                                  â”‚  â”ƒ
â”ƒ  â”‚  â€¢ IdVideo (FK â†’ Videos.IdVideo, unique)                                 â”‚  â”ƒ
â”ƒ  â”‚  â€¢ KEKCifrada (varbinary(MAX)) â†’ KEK cifrada con RSA-OAEP del servidor   â”‚  â”ƒ
â”ƒ  â”‚  â€¢ AlgoritmoKEK (nvarchar(50)) â†’ "RSA-OAEP-SHA256"                       â”‚  â”ƒ
â”ƒ  â”‚  â€¢ Nonce (varbinary(12)) â†’ ChaCha20 nonce                                â”‚  â”ƒ
â”ƒ  â”‚  â€¢ AuthTag (varbinary(16)) â†’ Poly1305 authentication tag                 â”‚  â”ƒ
â”ƒ  â”‚  â€¢ HashSHA256Original (varbinary(32)) â†’ Hash del video original          â”‚  â”ƒ
â”ƒ  â”‚  â€¢ HMACDelVideo (varbinary(64)) â†’ HMAC del video cifrado                 â”‚  â”ƒ
â”ƒ  â”‚  â€¢ AlgoritmoCifrado (nvarchar(50)) â†’ "ChaCha20-Poly1305"                 â”‚  â”ƒ
â”ƒ  â”‚  â€¢ FechaGeneracionClaves (datetime2)                                     â”‚  â”ƒ
â”ƒ  â”‚  â€¢ VersionAlgoritmo (nvarchar(20)) â†’ "1.0"                               â”‚  â”ƒ
â”ƒ  â”‚                                                                           â”‚  â”ƒ
â”ƒ  â”‚  RelaciÃ³n:                                                               â”‚  â”ƒ
â”ƒ  â”‚  â€¢ Video (1:1)                                                           â”‚  â”ƒ
â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”ƒ
â”ƒ                                                                                 â”ƒ
â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”ƒ
â”ƒ  â”‚  DbSet<Permission> Permisos                                              â”‚  â”ƒ
â”ƒ  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”ƒ
â”ƒ  â”‚  Tabla: Permisos                                                         â”‚  â”ƒ
â”ƒ  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                        â”‚  â”ƒ
â”ƒ  â”‚  Campos:                                                                 â”‚  â”ƒ
â”ƒ  â”‚  â€¢ IdPermiso (PK, Identity)                                              â”‚  â”ƒ
â”ƒ  â”‚  â€¢ IdVideo (FK â†’ Videos.IdVideo)                                         â”‚  â”ƒ
â”ƒ  â”‚  â€¢ IdUsuario (FK â†’ Usuarios.IdUsuario)                                   â”‚  â”ƒ
â”ƒ  â”‚  â€¢ TipoPermiso (nvarchar(50)) â†’ "Aprobado" | "Pendiente" | "Revocado"   â”‚  â”ƒ
â”ƒ  â”‚  â€¢ FechaOtorgamiento (datetime2)                                         â”‚  â”ƒ
â”ƒ  â”‚  â€¢ FechaExpiracion (datetime2, nullable)                                 â”‚  â”ƒ
â”ƒ  â”‚  â€¢ FechaRevocacion (datetime2, nullable)                                 â”‚  â”ƒ
â”ƒ  â”‚  â€¢ NumeroAccesos (int, default 0)                                        â”‚  â”ƒ
â”ƒ  â”‚  â€¢ LimiteAccesos (int, nullable) â†’ NULL = ilimitado                      â”‚  â”ƒ
â”ƒ  â”‚  â€¢ UltimoAcceso (datetime2, nullable)                                    â”‚  â”ƒ
â”ƒ  â”‚  â€¢ OtorgadoPor (int) â†’ IdUsuario del administrador                       â”‚  â”ƒ
â”ƒ  â”‚  â€¢ RevocadoPor (int, nullable)                                           â”‚  â”ƒ
â”ƒ  â”‚  â€¢ Justificacion (nvarchar(500), nullable)                               â”‚  â”ƒ
â”ƒ  â”‚                                                                           â”‚  â”ƒ
â”ƒ  â”‚  Ãndices:                                                                â”‚  â”ƒ
â”ƒ  â”‚  â€¢ IX_Permisos_IdVideo                                                   â”‚  â”ƒ
â”ƒ  â”‚  â€¢ IX_Permisos_IdUsuario                                                 â”‚  â”ƒ
â”ƒ  â”‚  â€¢ IX_Permisos_TipoPermiso                                               â”‚  â”ƒ
â”ƒ  â”‚                                                                           â”‚  â”ƒ
â”ƒ  â”‚  Relaciones:                                                             â”‚  â”ƒ
â”ƒ  â”‚  â€¢ Video (N:1)                                                           â”‚  â”ƒ
â”ƒ  â”‚  â€¢ Usuario (N:1)                                                         â”‚  â”ƒ
â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”ƒ
â”ƒ                                                                                 â”ƒ
â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”ƒ
â”ƒ  â”‚  DbSet<AccessLog> RegistroAccesos                                        â”‚  â”ƒ
â”ƒ  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”ƒ
â”ƒ  â”‚  Tabla: RegistroAccesos                                                  â”‚  â”ƒ
â”ƒ  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                 â”‚  â”ƒ
â”ƒ  â”‚  Campos:                                                                 â”‚  â”ƒ
â”ƒ  â”‚  â€¢ IdRegistro (PK, Identity)                                             â”‚  â”ƒ
â”ƒ  â”‚  â€¢ IdVideo (FK â†’ Videos.IdVideo)                                         â”‚  â”ƒ
â”ƒ  â”‚  â€¢ IdUsuario (FK â†’ Usuarios.IdUsuario)                                   â”‚  â”ƒ
â”ƒ  â”‚  â€¢ FechaAcceso (datetime2)                                               â”‚  â”ƒ
â”ƒ  â”‚  â€¢ TipoAcceso (nvarchar(50)) â†’ "Descarga" | "Streaming" | "KeyRequest"  â”‚  â”ƒ
â”ƒ  â”‚  â€¢ Exitoso (bit)                                                         â”‚  â”ƒ
â”ƒ  â”‚  â€¢ MensajeError (nvarchar(500), nullable)                                â”‚  â”ƒ
â”ƒ  â”‚  â€¢ DireccionIP (nvarchar(50), nullable)                                  â”‚  â”ƒ
â”ƒ  â”‚  â€¢ UserAgent (nvarchar(500), nullable)                                   â”‚  â”ƒ
â”ƒ  â”‚                                                                           â”‚  â”ƒ
â”ƒ  â”‚  Ãndices:                                                                â”‚  â”ƒ
â”ƒ  â”‚  â€¢ IX_RegistroAccesos_IdVideo                                            â”‚  â”ƒ
â”ƒ  â”‚  â€¢ IX_RegistroAccesos_IdUsuario                                          â”‚  â”ƒ
â”ƒ  â”‚  â€¢ IX_RegistroAccesos_FechaAcceso                                        â”‚  â”ƒ
â”ƒ  â”‚                                                                           â”‚  â”ƒ
â”ƒ  â”‚  Relaciones:                                                             â”‚  â”ƒ
â”ƒ  â”‚  â€¢ Video (N:1)                                                           â”‚  â”ƒ
â”ƒ  â”‚  â€¢ Usuario (N:1)                                                         â”‚  â”ƒ
â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”¯â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
                               â”‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â–¼â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ                      ğŸ’¿ CAPA DE PERSISTENCIA                                   â”ƒ
â”£â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”«
â”ƒ                                                                                 â”ƒ
â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”ƒ
â”ƒ  â”‚   ğŸ—„ï¸ SQL SERVER EXPRESS        â”‚      â”‚   ğŸ“ FILE SYSTEM STORAGE        â”‚   â”ƒ
â”ƒ  â”‚   Database: Data_base_cripto   â”‚      â”‚                                â”‚   â”ƒ
â”ƒ  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”ƒ
â”ƒ  â”‚                                â”‚      â”‚                                â”‚   â”ƒ
â”ƒ  â”‚ ğŸ“Š Tablas Principales:         â”‚      â”‚ ğŸ“‚ Storage/                    â”‚   â”ƒ
â”ƒ  â”‚                                â”‚      â”‚                                â”‚   â”ƒ
â”ƒ  â”‚ â€¢ Usuarios                     â”‚      â”‚   â”œâ”€â”€ ğŸ¬ Videos/               â”‚   â”ƒ
â”ƒ  â”‚   â”œâ”€ 6 columnas principales    â”‚      â”‚   â”‚   â”‚                        â”‚   â”ƒ
â”ƒ  â”‚   â”œâ”€ 5 columnas crypto         â”‚      â”‚   â”‚   â”œâ”€â”€ {guid1}.encrypted    â”‚   â”ƒ
â”ƒ  â”‚   â””â”€ 3 columnas metadata       â”‚      â”‚   â”‚   â”œâ”€â”€ {guid2}.encrypted    â”‚   â”ƒ
â”ƒ  â”‚                                â”‚      â”‚   â”‚   â”œâ”€â”€ {guid3}.encrypted    â”‚   â”ƒ
â”ƒ  â”‚ â€¢ ClavesUsuarios               â”‚      â”‚   â”‚   â””â”€â”€ ...                  â”‚   â”ƒ
â”ƒ  â”‚   â”œâ”€ IdClave (PK)              â”‚      â”‚   â”‚                            â”‚   â”ƒ
â”ƒ  â”‚   â”œâ”€ IdUsuario (FK)            â”‚      â”‚   â”‚   Formato:                 â”‚   â”ƒ
â”ƒ  â”‚   â”œâ”€ ClaveHMAC (64 bytes)      â”‚      â”‚   â”‚   â€¢ Nonce (12 bytes)       â”‚   â”ƒ
â”ƒ  â”‚   â”œâ”€ AlgoritmoHMAC             â”‚      â”‚   â”‚   â€¢ AuthTag (16 bytes)     â”‚   â”ƒ
â”ƒ  â”‚   â””â”€ FechaGeneracion           â”‚      â”‚   â”‚   â€¢ Ciphertext (variable)  â”‚   â”ƒ
â”ƒ  â”‚                                â”‚      â”‚   â”‚                            â”‚   â”ƒ
â”ƒ  â”‚ â€¢ Videos                       â”‚      â”‚   â””â”€â”€ ğŸ” Keys/                 â”‚   â”ƒ
â”ƒ  â”‚   â”œâ”€ 11 columnas               â”‚      â”‚       â”‚                        â”‚   â”ƒ
â”ƒ  â”‚   â”œâ”€ FK â†’ Usuarios             â”‚      â”‚       â”œâ”€â”€ server_public_key.pemâ”‚   â”ƒ
â”ƒ  â”‚   â””â”€ Estado procesamiento      â”‚      â”‚       â”‚   (RSA-4096 Public)    â”‚   â”ƒ
â”ƒ  â”‚                                â”‚      â”‚       â”‚                        â”‚   â”ƒ
â”ƒ  â”‚ â€¢ DatosCriptograficosVideos    â”‚      â”‚       â”œâ”€â”€ server_private_key   â”‚   â”ƒ
â”ƒ  â”‚   â”œâ”€ IdDatosCriptograficos(PK) â”‚      â”‚       â”‚   .pem.encrypted       â”‚   â”ƒ
â”ƒ  â”‚   â”œâ”€ IdVideo (FK, unique)      â”‚      â”‚       â”‚   (Cifrado ChaCha20)   â”‚   â”ƒ
â”ƒ  â”‚   â”œâ”€ KEKCifrada (512 bytes)    â”‚      â”‚       â”‚                        â”‚   â”ƒ
â”ƒ  â”‚   â”œâ”€ Nonce (12 bytes)          â”‚      â”‚       â””â”€â”€ .master_secret       â”‚   â”ƒ
â”ƒ  â”‚   â”œâ”€ AuthTag (16 bytes)        â”‚      â”‚           (256 bits)           â”‚   â”ƒ
â”ƒ  â”‚   â”œâ”€ HashSHA256 (32 bytes)     â”‚      â”‚                                â”‚   â”ƒ
â”ƒ  â”‚   â”œâ”€ HMAC (64 bytes)           â”‚      â”‚ ğŸ”’ Seguridad File System:      â”‚   â”ƒ
â”ƒ  â”‚   â””â”€ Algoritmos metadata       â”‚      â”‚   â€¢ Windows ACL permissions    â”‚   â”ƒ
â”ƒ  â”‚                                â”‚      â”‚   â€¢ Read-only para claves      â”‚   â”ƒ
â”ƒ  â”‚ â€¢ Permisos                     â”‚      â”‚   â€¢ VerificaciÃ³n integridad    â”‚   â”ƒ
â”ƒ  â”‚   â”œâ”€ 13 columnas               â”‚      â”‚   â€¢ Backup automÃ¡tico          â”‚   â”ƒ
â”ƒ  â”‚   â”œâ”€ FK â†’ Videos, Usuarios     â”‚      â”‚                                â”‚   â”ƒ
â”ƒ  â”‚   â”œâ”€ Control temporal          â”‚      â”‚ ğŸ“ TamaÃ±os tÃ­picos:            â”‚   â”ƒ
â”ƒ  â”‚   â””â”€ Contador accesos          â”‚      â”‚   â€¢ Keys: ~5 KB total          â”‚   â”ƒ
â”ƒ  â”‚                                â”‚      â”‚   â€¢ Videos: Variable           â”‚   â”ƒ
â”ƒ  â”‚ â€¢ RegistroAccesos              â”‚      â”‚     (overhead: +28 bytes)      â”‚   â”ƒ
â”ƒ  â”‚   â”œâ”€ 8 columnas                â”‚      â”‚                                â”‚   â”ƒ
â”ƒ  â”‚   â”œâ”€ FK â†’ Videos, Usuarios     â”‚      â”‚                                â”‚   â”ƒ
â”ƒ  â”‚   â”œâ”€ AuditorÃ­a completa        â”‚      â”‚                                â”‚   â”ƒ
â”ƒ  â”‚   â””â”€ IP + UserAgent            â”‚      â”‚                                â”‚   â”ƒ
â”ƒ  â”‚                                â”‚      â”‚                                â”‚   â”ƒ
â”ƒ  â”‚ ğŸ“ˆ EstadÃ­sticas:               â”‚      â”‚                                â”‚   â”ƒ
â”ƒ  â”‚   â€¢ Total Tablas: 6            â”‚      â”‚                                â”‚   â”ƒ
â”ƒ  â”‚   â€¢ Total Columnas: ~60        â”‚      â”‚                                â”‚   â”ƒ
â”ƒ  â”‚   â€¢ Foreign Keys: 8            â”‚      â”‚                                â”‚   â”ƒ
â”ƒ  â”‚   â€¢ Unique Constraints: 4      â”‚      â”‚                                â”‚   â”ƒ
â”ƒ  â”‚   â€¢ Indexes: 12+               â”‚      â”‚                                â”‚   â”ƒ
â”ƒ  â”‚                                â”‚      â”‚                                â”‚   â”ƒ
â”ƒ  â”‚ ğŸ” Seguridad SQL:              â”‚      â”‚                                â”‚   â”ƒ
â”ƒ  â”‚   â€¢ Encrypted connection       â”‚      â”‚                                â”‚   â”ƒ
â”ƒ  â”‚   â€¢ Parameterized queries      â”‚      â”‚                                â”‚   â”ƒ
â”ƒ  â”‚   â€¢ Transaction isolation      â”‚      â”‚                                â”‚   â”ƒ
â”ƒ  â”‚   â€¢ Backup diario automÃ¡tico   â”‚      â”‚                                â”‚   â”ƒ
â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
```

---

## ğŸ” Algoritmos CriptogrÃ¡ficos Implementados

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    SUITE CRIPTOGRÃFICA COMPLETA                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1ï¸âƒ£ CIFRADO SIMÃ‰TRICO (AEAD)                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  ChaCha20-Poly1305                                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                      â”‚
â”‚  â€¢ Tipo: AEAD (Authenticated Encryption with Associated Data)              â”‚
â”‚  â€¢ Cifrado: ChaCha20 (stream cipher)                                        â”‚
â”‚  â€¢ AutenticaciÃ³n: Poly1305 (MAC)                                            â”‚
â”‚  â€¢ Key: 256 bits (32 bytes)                                                 â”‚
â”‚  â€¢ Nonce: 96 bits (12 bytes) - Ãºnico por video                             â”‚
â”‚  â€¢ AuthTag: 128 bits (16 bytes)                                             â”‚
â”‚  â€¢ Uso: Cifrado de contenido de video                                       â”‚
â”‚  â€¢ Velocidad: ~3.8 GB/s en hardware moderno                                 â”‚
â”‚  â€¢ Seguridad: Equivalente a AES-256-GCM, sin timing attacks                â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2ï¸âƒ£ CIFRADO ASIMÃ‰TRICO                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  RSA-4096 con OAEP                                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                      â”‚
â”‚  â€¢ TamaÃ±o de clave: 4096 bits                                               â”‚
â”‚  â€¢ Padding: OAEP (Optimal Asymmetric Encryption Padding)                    â”‚
â”‚  â€¢ Hash: SHA-256                                                            â”‚
â”‚  â€¢ MGF: MGF1-SHA256                                                         â”‚
â”‚  â€¢ Uso: Cifrado de KEK (Key Encryption Key)                                 â”‚
â”‚  â€¢ Max plaintext: 446 bytes (con OAEP-SHA256)                               â”‚
â”‚  â€¢ Ciphertext: 512 bytes                                                    â”‚
â”‚  â€¢ GeneraciÃ³n: < 2 segundos                                                 â”‚
â”‚  â€¢ Formato: PEM (Privacy Enhanced Mail)                                     â”‚
â”‚                                                                              â”‚
â”‚  Claves Generadas:                                                          â”‚
â”‚  â€¢ Par de claves del servidor (startup)                                     â”‚
â”‚  â€¢ Par de claves por usuario (registro)                                     â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3ï¸âƒ£ FUNCIONES HASH                                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  SHA-256                                                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€                                                                   â”‚
â”‚  â€¢ Output: 256 bits (32 bytes)                                              â”‚
â”‚  â€¢ Uso 1: Hash de videos originales (integridad)                            â”‚
â”‚  â€¢ Uso 2: PBKDF2 para derivaciÃ³n de passwords                               â”‚
â”‚  â€¢ Uso 3: Firma HMAC                                                        â”‚
â”‚  â€¢ ColisiÃ³n: Computacionalmente imposible (2^128 operaciones)              â”‚
â”‚                                                                              â”‚
â”‚  PBKDF2-SHA256                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                             â”‚
â”‚  â€¢ Iteraciones: 100,000                                                     â”‚
â”‚  â€¢ Salt: 128 bits (16 bytes) Ãºnico por usuario                              â”‚
â”‚  â€¢ Output: 256 bits (32 bytes)                                              â”‚
â”‚  â€¢ Uso: Almacenamiento seguro de passwords                                  â”‚
â”‚  â€¢ Tiempo: ~100ms (mitigaciÃ³n de ataques de fuerza bruta)                  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4ï¸âƒ£ MESSAGE AUTHENTICATION CODES (MAC)                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  HMAC-SHA256                                                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                               â”‚
â”‚  â€¢ Key: 512 bits (64 bytes) - generada por admin                            â”‚
â”‚  â€¢ Output: 256 bits (32 bytes)                                              â”‚
â”‚  â€¢ Uso: AutenticaciÃ³n de videos cifrados                                    â”‚
â”‚  â€¢ VerificaciÃ³n: Constant-time comparison (anti-timing attack)              â”‚
â”‚  â€¢ Fortaleza: Resistente a ataques de extensiÃ³n de longitud                â”‚
â”‚                                                                              â”‚
â”‚  KMAC256 (SHA-3 based)                                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                     â”‚
â”‚  â€¢ Basado en: Keccak/SHA-3                                                  â”‚
â”‚  â€¢ Output: Variable (256 bits tÃ­pico)                                       â”‚
â”‚  â€¢ Uso: MAC alternativo moderno                                             â”‚
â”‚  â€¢ Ventaja: Mayor flexibilidad que HMAC                                     â”‚
â”‚                                                                              â”‚
â”‚  Poly1305 (integrado en ChaCha20-Poly1305)                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                â”‚
â”‚  â€¢ Output: 128 bits (16 bytes)                                              â”‚
â”‚  â€¢ Uso: AuthTag de videos cifrados                                          â”‚
â”‚  â€¢ Velocidad: Extremadamente rÃ¡pido                                         â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5ï¸âƒ£ GENERACIÃ“N DE NÃšMEROS ALEATORIOS                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  RandomNumberGenerator (CSPRNG)                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                             â”‚
â”‚  â€¢ Fuente: OS-level CSPRNG (Windows: BCrypt)                                â”‚
â”‚  â€¢ Uso:                                                                     â”‚
â”‚    â”œâ”€ KEK (32 bytes por video)                                              â”‚
â”‚    â”œâ”€ Nonce ChaCha20 (12 bytes por video)                                   â”‚
â”‚    â”œâ”€ Salt PBKDF2 (16 bytes por usuario)                                    â”‚
â”‚    â”œâ”€ HMAC Key (64 bytes por admin)                                         â”‚
â”‚    â””â”€ Master Secret (32 bytes del servidor)                                 â”‚
â”‚                                                                              â”‚
â”‚  â€¢ Calidad: Cryptographically Secure                                        â”‚
â”‚  â€¢ Predictibilidad: Imposible                                               â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Flujos de Datos Principales

### ğŸ“¤ Flujo 1: Subida y Cifrado de Video

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PASO 1: Administrador sube video desde UploadVideo.cshtml                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /api/videos/upload                                                    â”‚
â”‚  Content-Type: multipart/form-data                                         â”‚
â”‚  Authorization: Bearer {JWT-admin-token}                                    â”‚
â”‚  Body:                                                                      â”‚
â”‚    â€¢ VideoFile: IFormFile (binary)                                         â”‚
â”‚    â€¢ Titulo: string                                                        â”‚
â”‚    â€¢ Descripcion: string (opcional)                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VideosController.UploadVideo()                                             â”‚
â”‚  â€¢ Validar JWT y extraer adminId                                           â”‚
â”‚  â€¢ Validar rol "Administrador"                                             â”‚
â”‚  â€¢ Validar archivo (tamaÃ±o, tipo)                                          â”‚
â”‚  â€¢ Llamar VideoService.UploadVideoAsync()                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VideoService.UploadVideoAsync()                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  1. Verificar usuario es Administrador (DB query)                          â”‚
â”‚  2. Obtener HMAC key del admin desde ClavesUsuarios                        â”‚
â”‚  3. Guardar video temporal: Storage/Videos/temp_{guid}.tmp                 â”‚
â”‚  4. Obtener clave pÃºblica del servidor                                     â”‚
â”‚  5. Invocar VideoEncryptionService.EncryptVideoAsync()                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VideoEncryptionService.EncryptVideoAsync()                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                             â”‚
â”‚  FASE 1: LECTURA Y HASH DEL ORIGINAL                                       â”‚
â”‚  â”œâ”€ Abrir FileStream (input)                                               â”‚
â”‚  â”œâ”€ Leer en chunks de 80KB                                                 â”‚
â”‚  â””â”€ Calcular SHA-256 progresivo â†’ OriginalHash (32 bytes)                  â”‚
â”‚                                                                             â”‚
â”‚  FASE 2: GENERACIÃ“N DE KEK                                                 â”‚
â”‚  â”œâ”€ RandomNumberGenerator.GetBytes(32) â†’ KEK (256 bits)                    â”‚
â”‚  â””â”€ KEK Ãºnica para este video                                              â”‚
â”‚                                                                             â”‚
â”‚  FASE 3: CIFRADO DE KEK                                                    â”‚
â”‚  â”œâ”€ RsaService.Encrypt(KEK, serverPublicKey)                               â”‚
â”‚  â”œâ”€ Usar RSA-OAEP-SHA256                                                   â”‚
â”‚  â””â”€ Resultado: EncryptedKEK (512 bytes)                                    â”‚
â”‚                                                                             â”‚
â”‚  FASE 4: CIFRADO DEL VIDEO                                                 â”‚
â”‚  â”œâ”€ Generar Nonce aleatorio (12 bytes)                                     â”‚
â”‚  â”œâ”€ ChaCha20Poly1305Service.Encrypt()                                      â”‚
â”‚  â”‚   â€¢ Key: KEK (32 bytes)                                                 â”‚
â”‚  â”‚   â€¢ Nonce: 12 bytes                                                     â”‚
â”‚  â”‚   â€¢ Plaintext: Video bytes                                              â”‚
â”‚  â”‚   â€¢ Output: Ciphertext + AuthTag (16 bytes)                             â”‚
â”‚  â”œâ”€ Escribir a Storage/Videos/{guid}.encrypted                             â”‚
â”‚  â””â”€ Formato: [Nonce 12B][AuthTag 16B][Ciphertext]                          â”‚
â”‚                                                                             â”‚
â”‚  FASE 5: CÃLCULO DE HMAC                                                   â”‚
â”‚  â”œâ”€ HmacService.ComputeHmac()                                              â”‚
â”‚  â”œâ”€ Key: Admin HMAC Key (64 bytes)                                         â”‚
â”‚  â”œâ”€ Data: Archivo cifrado completo                                         â”‚
â”‚  â””â”€ Output: HMAC (32 bytes)                                                â”‚
â”‚                                                                             â”‚
â”‚  RETORNO: VideoEncryptionResult {                                          â”‚
â”‚    EncryptedKek: 512 bytes                                                 â”‚
â”‚    Nonce: 12 bytes                                                         â”‚
â”‚    AuthTag: 16 bytes                                                       â”‚
â”‚    OriginalHash: 32 bytes                                                  â”‚
â”‚    HmacOfEncryptedVideo: 32 bytes                                          â”‚
â”‚    OriginalSizeBytes: long                                                 â”‚
â”‚    EncryptedSizeBytes: long                                                â”‚
â”‚  }                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VideoService (continuaciÃ³n)                                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  6. Eliminar archivo temporal                                              â”‚
â”‚  7. BEGIN TRANSACTION                                                       â”‚
â”‚  8. INSERT INTO Videos (...)                                               â”‚
â”‚  9. INSERT INTO DatosCriptograficosVideos (...)                            â”‚
â”‚  10. COMMIT TRANSACTION                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Response 200 OK                                                            â”‚
â”‚  {                                                                          â”‚
â”‚    "success": true,                                                        â”‚
â”‚    "data": {                                                               â”‚
â”‚      "idVideo": 1,                                                         â”‚
â”‚      "tituloVideo": "Mi Video",                                            â”‚
â”‚      "tamaÃ±oArchivo": 15728640,                                            â”‚
â”‚      "estadoProcesamiento": "Disponible"                                   â”‚
â”‚    },                                                                       â”‚
â”‚    "message": "Video subido y cifrado exitosamente"                        â”‚
â”‚  }                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ”‘ Flujo 2: DistribuciÃ³n de Claves (Key Distribution con Claves EfÃ­meras)

**âš ï¸ MODELO DE SEGURIDAD MEJORADO: CLAVES EFÃMERAS (Ephemeral Keys)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PASO 1: Usuario consumidor solicita acceso a video                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VideoPlayer.cshtml                                                         â”‚
â”‚  â€¢ Usuario hace clic en "Ver Video" desde VideoGrid o Home                 â”‚
â”‚  â€¢ JavaScript: initializeVideoPlayer(videoId)                               â”‚
â”‚  â€¢ ğŸ” SEGURIDAD: Cliente genera par RSA TEMPORAL en RAM (2048 bits)        â”‚
â”‚  â€¢ âš ï¸ CRÃTICO: Claves NUNCA se almacenan (ni localStorage ni archivos)     â”‚
â”‚  â€¢ Claves solo existen en memoria durante reproducciÃ³n                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GeneraciÃ³n de Claves Temporales (Web Crypto API)                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  window.crypto.subtle.generateKey({                                         â”‚
â”‚    name: "RSA-OAEP",                                                        â”‚
â”‚    modulusLength: 2048,                                                     â”‚
â”‚    publicExponent: [1, 0, 1],  // 65537                                    â”‚
â”‚    hash: "SHA-256"                                                          â”‚
â”‚  }, true, ["encrypt", "decrypt"])                                          â”‚
â”‚                                                                             â”‚
â”‚  âœ… VENTAJAS:                                                               â”‚
â”‚  â€¢ Zero-Storage: No hay archivos descargables vulnerables                  â”‚
â”‚  â€¢ Zero-Persistence: No hay localStorage ni cookies con claves             â”‚
â”‚  â€¢ Auto-Destruction: GC destruye claves al cerrar pestaÃ±a                  â”‚
â”‚  â€¢ True Zero-Knowledge: Servidor nunca conoce clave privada temporal       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GET /api/videos/{videoId}/stream                                           â”‚
â”‚  Authorization: Bearer {JWT-token}                                          â”‚
â”‚  â€¢ Servidor valida JWT y permisos                                          â”‚
â”‚  â€¢ Servidor descifra video con KEK                                         â”‚
â”‚  â€¢ Servidor envÃ­a video descifrado por HTTPS                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VideoPlayer.cshtml.cs.OnPostGetKeyPackageAsync()                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  1. Validar sesiÃ³n: UserId presente                                        â”‚
â”‚  2. Validar videoId y userPublicKey no vacÃ­os                              â”‚
â”‚  3. VERIFICACIÃ“N DE ACCESO:                                                â”‚
â”‚     a) Verificar si usuario es admin dueÃ±o del video                       â”‚
â”‚     b) Si NO es dueÃ±o â†’ verificar permisos en tabla Permisos              â”‚
â”‚  4. Invocar KeyDistributionService.GetKeyPackageAsync()                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  KeyDistributionService.GetKeyPackageAsync()                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                             â”‚
â”‚  PASO 1: ValidaciÃ³n de Identidad                                           â”‚
â”‚  â”œâ”€ Query: SELECT * FROM Usuarios WHERE IdUsuario = @userId                â”‚
â”‚  â””â”€ Verificar usuario existe                                               â”‚
â”‚                                                                             â”‚
â”‚  PASO 2: ObtenciÃ³n del Video                                               â”‚
â”‚  â”œâ”€ Query: SELECT v.*, dc.* FROM Videos v                                  â”‚
â”‚  â”‚         JOIN DatosCriptograficosVideos dc ON v.IdVideo = dc.IdVideo     â”‚
â”‚  â”‚         WHERE v.IdVideo = @videoId                                      â”‚
â”‚  â””â”€ Recuperar: KEKCifrado, Nonce, AuthTag, OriginalHash, HMAC             â”‚
â”‚                                                                             â”‚
â”‚  PASO 3: VerificaciÃ³n de Acceso (Security Gate)                            â”‚
â”‚  â”œâ”€ bool isAdminOwner = (usuario.TipoUsuario == "Administrador" &&        â”‚
â”‚  â”‚                        video.IdAdministrador == userId)                 â”‚
â”‚  â””â”€ Si NO es admin dueÃ±o:                                                  â”‚
â”‚       â”œâ”€ Query: SELECT * FROM Permisos                                     â”‚
â”‚       â”‚         WHERE IdVideo = @videoId AND IdUsuarioConsumidor = @userId â”‚
â”‚       â”‚         AND FechaExpiracion > GETDATE()                            â”‚
â”‚       â””â”€ Si NO existe permiso â†’ THROW UnauthorizedAccessException          â”‚
â”‚                                                                             â”‚
â”‚  PASO 4: Descifrado de KEK con Clave Privada del Servidor                 â”‚
â”‚  â”œâ”€ Query: SELECT ClavePrivadaCifrada, IvClavePrivada                      â”‚
â”‚  â”‚         FROM ClavesUsuarios WHERE IdUsuario = 0 (Servidor)              â”‚
â”‚  â”œâ”€ PrivateKeyEncryptionService.DecryptPrivateKey()                        â”‚
â”‚  â”‚   â€¢ Descifrar con clave maestra del servidor                            â”‚
â”‚  â”œâ”€ RsaService.Decrypt(KEKCifrado, serverPrivateKey)                       â”‚
â”‚  â””â”€ Resultado: KEK (32 bytes) en texto plano                               â”‚
â”‚                                                                             â”‚
â”‚  PASO 5: Re-cifrado de KEK con Clave PÃºblica del Usuario                  â”‚
â”‚  â”œâ”€ Validar userPublicKey con RSA PEM format                               â”‚
â”‚  â”œâ”€ RsaService.Encrypt(KEK, userPublicKey)                                 â”‚
â”‚  â”‚   â€¢ Usar RSA-OAEP-SHA256                                                â”‚
â”‚  â””â”€ Resultado: KEKReCifrado (512 bytes)                                    â”‚
â”‚                                                                             â”‚
â”‚  PASO 6: ConstrucciÃ³n del Key Package                                      â”‚
â”‚  â””â”€ Retornar KeyPackageDto {                                               â”‚
â”‚       EncryptedKek: Base64(KEKReCifrado),                                  â”‚
â”‚       Nonce: Base64(Nonce),                                                â”‚
â”‚       AuthTag: Base64(AuthTag),                                            â”‚
â”‚       OriginalHash: Base64(OriginalHash),                                  â”‚
â”‚       VideoPath: "/api/streaming/video/{videoId}"                          â”‚
â”‚     }                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Response 200 OK (JSON)                                                     â”‚
â”‚  {                                                                          â”‚
â”‚    "encryptedKek": "aBc123...==",   // 512 bytes Base64                    â”‚
â”‚    "nonce": "xYz789...==",          // 12 bytes Base64                     â”‚
â”‚    "authTag": "pQr456...==",        // 16 bytes Base64                     â”‚
â”‚    "originalHash": "mNo012...==",   // 32 bytes Base64                     â”‚
â”‚    "videoPath": "/api/streaming/video/1"                                   â”‚
â”‚  }                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“º Flujo 3: ReproducciÃ³n y Descifrado de Video

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PASO 1: Cliente recibe Key Package                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  JavaScript en VideoPlayer.cshtml                                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  1. Parsear respuesta JSON                                                 â”‚
â”‚  2. Decodificar Base64: encryptedKek, nonce, authTag, originalHash         â”‚
â”‚  3. Descifrar KEK con clave privada temporal (RSA-OAEP en cliente)         â”‚
â”‚  4. Almacenar KEK en memoria del navegador                                 â”‚
â”‚  5. Inicializar reproductor de video con videoPath                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GET /api/streaming/video/1                                                 â”‚
â”‚  Range: bytes=0-                                                           â”‚
â”‚  Authorization: Bearer {token}                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  StreamingController.StreamVideo()                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  1. Validar JWT y extraer userId                                           â”‚
â”‚  2. Verificar permisos (mismo flujo que KeyDistribution)                   â”‚
â”‚  3. Invocar VideoStreamingService.StreamVideoAsync()                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VideoStreamingService.StreamVideoAsync()                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  1. Localizar archivo: Storage/Videos/{guid}.encrypted                     â”‚
â”‚  2. Validar existencia del archivo                                         â”‚
â”‚  3. Parsear Range header (inicio-fin)                                      â”‚
â”‚  4. Abrir FileStream con FileMode.Open, FileAccess.Read                    â”‚
â”‚  5. Buscar posiciÃ³n: stream.Seek(rangeStart, SeekOrigin.Begin)             â”‚
â”‚  6. Leer chunk solicitado                                                  â”‚
â”‚  7. Registrar acceso en RegistroAccesos                                    â”‚
â”‚  8. Retornar FileStreamResult con:                                         â”‚
â”‚     â€¢ Content-Type: video/mp4                                              â”‚
â”‚     â€¢ Accept-Ranges: bytes                                                 â”‚
â”‚     â€¢ Content-Range: bytes {start}-{end}/{total}                           â”‚
â”‚     â€¢ Status: 206 Partial Content                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cliente recibe chunks cifrados                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  FASE 1: DESCIFRADO CON CHACHA20-POLY1305                                  â”‚
â”‚  â”œâ”€ Extraer Nonce (primeros 12 bytes)                                      â”‚
â”‚  â”œâ”€ Extraer AuthTag (siguientes 16 bytes)                                  â”‚
â”‚  â”œâ”€ Ciphertext = resto del chunk                                           â”‚
â”‚  â”œâ”€ Usar libsodium.js o WebCrypto API                                      â”‚
â”‚  â”œâ”€ ChaCha20Poly1305.Decrypt(ciphertext, KEK, nonce, authTag)              â”‚
â”‚  â””â”€ Resultado: Video bytes en claro                                        â”‚
â”‚                                                                             â”‚
â”‚  FASE 2: VERIFICACIÃ“N DE INTEGRIDAD                                        â”‚
â”‚  â”œâ”€ Calcular SHA-256 del video descifrado completo                         â”‚
â”‚  â”œâ”€ Comparar con originalHash recibido                                     â”‚
â”‚  â””â”€ Si NO coincide â†’ Mostrar error de integridad                           â”‚
â”‚                                                                             â”‚
â”‚  FASE 3: REPRODUCCIÃ“N                                                      â”‚
â”‚  â”œâ”€ Crear Blob URL desde ArrayBuffer descifrado                            â”‚
â”‚  â”œâ”€ Asignar al elemento <video>: videoElement.src = blobUrl               â”‚
â”‚  â””â”€ Reproducir con controles HTML5                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ‘¤ Flujo 4: Otorgamiento de Permisos (Admin â†’ Consumer)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PASO 1: Admin selecciona video y usuarios en ManagePermissions.cshtml       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /ManagePermissions?handler=GrantPermission                            â”‚
â”‚  Session: Admin autenticado                                                â”‚
â”‚  Body: {                                                                    â”‚
â”‚    videoId: 1,                                                             â”‚
â”‚    consumerIds: [5, 7, 12],                                                â”‚
â”‚    expirationDate: "2025-12-31"                                            â”‚
â”‚  }                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ManagePermissions.cshtml.cs.OnPostGrantPermissionAsync()                   â”‚
â”‚  1. Validar sesiÃ³n: Admin dueÃ±o del video                                  â”‚
â”‚  2. Validar videoId y consumerIds                                          â”‚
â”‚  3. Invocar PermissionService.GrantPermissionAsync()                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PermissionService.GrantPermissionAsync()                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  1. BEGIN TRANSACTION                                                       â”‚
â”‚  2. Verificar video existe y adminId es dueÃ±o                              â”‚
â”‚  3. Para cada consumerId:                                                  â”‚
â”‚     a) Verificar usuario existe y es tipo "Consumidor"                     â”‚
â”‚     b) Verificar permiso no existe (evitar duplicados)                     â”‚
â”‚     c) INSERT INTO Permisos (                                              â”‚
â”‚          IdVideo,                                                          â”‚
â”‚          IdAdministrador,                                                  â”‚
â”‚          IdUsuarioConsumidor,                                              â”‚
â”‚          FechaOtorgamiento = GETDATE(),                                    â”‚
â”‚          FechaExpiracion                                                   â”‚
â”‚        )                                                                    â”‚
â”‚  4. COMMIT TRANSACTION                                                      â”‚
â”‚  5. Retornar lista de permisos creados                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Response 200 OK                                                            â”‚
â”‚  {                                                                          â”‚
â”‚    "success": true,                                                        â”‚
â”‚    "message": "Permisos otorgados a 3 usuarios",                           â”‚
â”‚    "data": [                                                               â”‚
â”‚      { "idPermiso": 101, "userId": 5, "username": "consumer01" },          â”‚
â”‚      { "idPermiso": 102, "userId": 7, "username": "consumer02" },          â”‚
â”‚      { "idPermiso": 103, "userId": 12, "username": "consumer03" }          â”‚
â”‚    ]                                                                        â”‚
â”‚  }                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”’ Capas de Seguridad del Sistema

El sistema implementa 6 capas de seguridad concÃ©ntricas:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CAPA 1: AUTENTICACIÃ“N (Authentication)                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  â€¢ JWT Tokens para API (Bearer Authorization)                              â”‚
â”‚  â€¢ Session-based Auth para Razor Pages                                     â”‚
â”‚  â€¢ Password Hashing: PBKDF2-SHA256 (100,000 iteraciones)                   â”‚
â”‚  â€¢ Salt Ãºnico por usuario (128 bits)                                       â”‚
â”‚  â€¢ Token expiration: 1 hora                                                â”‚
â”‚  â€¢ Refresh tokens no implementados                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CAPA 2: AUTORIZACIÃ“N (Authorization)                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  â€¢ Role-Based Access Control (RBAC)                                         â”‚
â”‚  â€¢ Roles: "Administrador" | "Consumidor"                                   â”‚
â”‚  â€¢ [Authorize(Roles = "Administrador")] en endpoints crÃ­ticos              â”‚
â”‚  â€¢ Admin puede: subir, eliminar, gestionar permisos                        â”‚
â”‚  â€¢ Consumer puede: ver videos autorizados                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CAPA 3: PERMISOS GRANULARES (Granular Permissions)                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  â€¢ Tabla Permisos: Admin â†’ Consumer â†’ Video mapping                        â”‚
â”‚  â€¢ Fecha de expiraciÃ³n por permiso                                         â”‚
â”‚  â€¢ Admin owner bypass: dueÃ±o siempre tiene acceso                          â”‚
â”‚  â€¢ ValidaciÃ³n en KeyDistribution y Streaming                               â”‚
â”‚  â€¢ RevocaciÃ³n instantÃ¡nea mediante DELETE                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CAPA 4: DISTRIBUCIÃ“N SEGURA DE CLAVES (Secure Key Distribution)           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  â€¢ KEK nunca viaja en texto plano                                          â”‚
â”‚  â€¢ KEK cifrada con RSA-4096 del servidor al subir                          â”‚
â”‚  â€¢ KEK re-cifrada con RSA temporal del cliente al distribuir               â”‚
â”‚  â€¢ Clave privada del servidor cifrada con AES-256                          â”‚
â”‚  â€¢ Key Package incluye nonce, authTag, hash para validaciÃ³n                â”‚
â”‚  â€¢ Claves temporales del cliente generadas en navegador                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CAPA 5: CIFRADO DE VIDEO (Video Encryption)                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  â€¢ ChaCha20-Poly1305 AEAD                                                   â”‚
â”‚  â€¢ KEK Ãºnica por video (256 bits)                                          â”‚
â”‚  â€¢ Nonce aleatorio de 96 bits                                              â”‚
â”‚  â€¢ Authentication Tag de 128 bits                                           â”‚
â”‚  â€¢ Video nunca almacenado en texto plano                                   â”‚
â”‚  â€¢ Streaming de chunks cifrados con Range requests                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CAPA 6: INTEGRIDAD Y AUDITABILIDAD (Integrity & Audit)                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  â€¢ SHA-256 del video original                                              â”‚
â”‚  â€¢ HMAC-SHA256 del video cifrado (con HMAC Key del admin)                  â”‚
â”‚  â€¢ VerificaciÃ³n de integridad en cliente                                   â”‚
â”‚  â€¢ RegistroAccesos: log de cada visualizaciÃ³n                              â”‚
â”‚  â€¢ PublicKeyFingerprint: validaciÃ³n de claves RSA                          â”‚
â”‚  â€¢ DetecciÃ³n de manipulaciÃ³n mediante authTag de Poly1305                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š EstadÃ­sticas del Sistema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  COMPONENTES                                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  API Controllers:           11                                              â”‚
â”‚  Razor Pages:               15+                                             â”‚
â”‚  Business Services:         7                                               â”‚
â”‚  Cryptography Services:     9                                               â”‚
â”‚  Database Entities:         6                                               â”‚
â”‚  DTOs:                      20+                                             â”‚
â”‚  Total Lines of Code:       ~8,000 (estimado)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API ENDPOINTS                                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  POST   /api/auth/register                  - Registro de usuario          â”‚
â”‚  POST   /api/auth/login                     - Login con JWT                â”‚
â”‚  POST   /api/auth/logout                    - Logout                       â”‚
â”‚  GET    /api/users                          - Listar usuarios              â”‚
â”‚  GET    /api/users/{id}                     - Detalle de usuario           â”‚
â”‚  POST   /api/videos/upload                  - Subir y cifrar video         â”‚
â”‚  GET    /api/videos                         - Listar videos (con filtros)  â”‚
â”‚  GET    /api/videos/{id}                    - Detalle de video             â”‚
â”‚  DELETE /api/videos/{id}                    - Eliminar video               â”‚
â”‚  POST   /api/permissions/grant              - Otorgar permiso              â”‚
â”‚  DELETE /api/permissions/{id}               - Revocar permiso              â”‚
â”‚  GET    /api/permissions/video/{id}         - Permisos de un video         â”‚
â”‚  POST   /api/keydistribution/request/{id}   - Solicitar Key Package        â”‚
â”‚  GET    /api/streaming/video/{id}           - Stream de video cifrado      â”‚
â”‚  GET    /api/videogrid                      - Grid de videos con thumbnailsâ”‚
â”‚  GET    /api/health                         - Health check                 â”‚
â”‚  POST   /api/debug/test-encryption          - Test de cifrado              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CAPACIDADES DEL SISTEMA                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ… Registro y autenticaciÃ³n dual (JWT + Session)                          â”‚
â”‚  âœ… Subida de videos con cifrado automÃ¡tico                                â”‚
â”‚  âœ… GestiÃ³n de permisos granulares por video                               â”‚
â”‚  âœ… DistribuciÃ³n segura de claves con re-cifrado RSA                       â”‚
â”‚  âœ… Streaming de video cifrado con Range requests                          â”‚
â”‚  âœ… Descifrado en cliente con verificaciÃ³n de integridad                   â”‚
â”‚  âœ… Dashboard diferenciado por rol (Admin vs Consumer)                     â”‚
â”‚  âœ… Grid de videos con thumbnails                                          â”‚
â”‚  âœ… Reproductor modal para admins con lista de usuarios autorizados        â”‚
â”‚  âœ… AuditorÃ­a completa de accesos                                          â”‚
â”‚  âœ… VerificaciÃ³n de integridad con SHA-256 y HMAC                          â”‚
â”‚  âœ… ProtecciÃ³n contra manipulaciÃ³n con Poly1305 AuthTag                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš™ï¸ ConfiguraciÃ³n y Despliegue

### ğŸ“‹ ConfiguraciÃ³n de Base de Datos

```json
// appsettings.json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=.\\SQLEXPRESS;Database=Data_base_cripto;Trusted_Connection=True;TrustServerCertificate=True;MultipleActiveResultSets=true"
  },
  "Jwt": {
    "SecretKey": "{HMAC-SHA256-Secret-512bits}",
    "Issuer": "SecureVideoStreaming",
    "Audience": "SecureVideoStreamingUsers",
    "ExpirationMinutes": 60
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  }
}
```

### ğŸš€ Pipeline de Inicio (Startup)

```
Program.cs
â”œâ”€ builder.Services.AddDbContext<ApplicationDbContext>()
â”œâ”€ builder.Services.AddAuthentication(JwtBearer + Cookie)
â”œâ”€ builder.Services.AddAuthorization()
â”œâ”€ ServiceExtensions.AddBusinessServices(builder.Services)
â”‚   â”œâ”€ AddScoped<IAuthService, AuthService>()
â”‚   â”œâ”€ AddScoped<IUserService, UserService>()
â”‚   â”œâ”€ AddScoped<IVideoService, VideoService>()
â”‚   â”œâ”€ AddScoped<IPermissionService, PermissionService>()
â”‚   â”œâ”€ AddScoped<IKeyDistributionService, KeyDistributionService>()
â”‚   â”œâ”€ AddScoped<IVideoStreamingService, VideoStreamingService>()
â”‚   â””â”€ AddScoped<IVideoGridService, VideoGridService>()
â”œâ”€ ServiceExtensions.AddCryptographyServices(builder.Services)
â”‚   â”œâ”€ AddSingleton<IChaCha20Poly1305Service, ChaCha20Poly1305Service>()
â”‚   â”œâ”€ AddSingleton<IRsaService, RsaService>()
â”‚   â”œâ”€ AddSingleton<IKekService, KekService>()
â”‚   â”œâ”€ AddSingleton<IHashService, HashService>()
â”‚   â”œâ”€ AddSingleton<IHmacService, HmacService>()
â”‚   â”œâ”€ AddSingleton<IKmacService, KmacService>()
â”‚   â”œâ”€ AddScoped<IVideoEncryptionService, VideoEncryptionService>()
â”‚   â”œâ”€ AddScoped<IKeyManagementService, KeyManagementService>()
â”‚   â””â”€ AddScoped<IPrivateKeyEncryptionService, PrivateKeyEncryptionService>()
â”œâ”€ builder.Services.AddRazorPages()
â”œâ”€ builder.Services.AddControllersWithViews()
â””â”€ app.UseMiddleware<ErrorHandlingMiddleware>()
    â”œâ”€ app.UseAuthentication()
    â”œâ”€ app.UseAuthorization()
    â”œâ”€ app.MapRazorPages()
    â”œâ”€ app.MapControllers()
    â””â”€ app.Run()
```

### ğŸ—„ï¸ Migraciones de Base de Datos

```powershell
# Crear migraciÃ³n inicial
dotnet ef migrations add InitialCreate --project SecureVideoStreaming.API

# Aplicar migraciones
dotnet ef database update --project SecureVideoStreaming.API

# Script SQL generado incluye:
CREATE TABLE Usuarios (
    IdUsuario INT PRIMARY KEY IDENTITY(1,1),
    NombreUsuario NVARCHAR(50) UNIQUE NOT NULL,
    PasswordHash NVARCHAR(255) NOT NULL,
    Salt NVARCHAR(255) NOT NULL,
    TipoUsuario NVARCHAR(20) NOT NULL,
    ClavePublicaRSA NVARCHAR(MAX) NOT NULL,
    PublicKeyFingerprint NVARCHAR(64) NOT NULL,
    FechaCreacion DATETIME2 DEFAULT GETDATE()
);

CREATE TABLE ClavesUsuarios (
    IdClaveUsuario INT PRIMARY KEY IDENTITY(1,1),
    IdUsuario INT FOREIGN KEY REFERENCES Usuarios(IdUsuario) ON DELETE CASCADE,
    ClavePrivadaCifrada NVARCHAR(MAX),
    IvClavePrivada NVARCHAR(100),
    HmacKey NVARCHAR(MAX) NOT NULL,
    HmacIv NVARCHAR(100) NOT NULL,
    FechaGeneracion DATETIME2 DEFAULT GETDATE()
);

CREATE TABLE Videos (
    IdVideo INT PRIMARY KEY IDENTITY(1,1),
    IdAdministrador INT FOREIGN KEY REFERENCES Usuarios(IdUsuario) ON DELETE CASCADE,
    TituloVideo NVARCHAR(200) NOT NULL,
    DescripcionVideo NVARCHAR(MAX),
    RutaArchivoCifrado NVARCHAR(500) NOT NULL,
    TamaÃ±oArchivo BIGINT NOT NULL,
    EstadoProcesamiento NVARCHAR(50) DEFAULT 'Disponible',
    FechaSubida DATETIME2 DEFAULT GETDATE()
);

CREATE TABLE DatosCriptograficosVideos (
    IdDatoCriptografico INT PRIMARY KEY IDENTITY(1,1),
    IdVideo INT FOREIGN KEY REFERENCES Videos(IdVideo) ON DELETE CASCADE,
    KEKCifrado NVARCHAR(MAX) NOT NULL,
    Nonce NVARCHAR(100) NOT NULL,
    AuthTag NVARCHAR(100) NOT NULL,
    HashOriginal NVARCHAR(100) NOT NULL,
    HMACDelArchivoCifrado NVARCHAR(100) NOT NULL,
    FechaGeneracion DATETIME2 DEFAULT GETDATE()
);

CREATE TABLE Permisos (
    IdPermiso INT PRIMARY KEY IDENTITY(1,1),
    IdVideo INT FOREIGN KEY REFERENCES Videos(IdVideo) ON DELETE CASCADE,
    IdAdministrador INT FOREIGN KEY REFERENCES Usuarios(IdUsuario),
    IdUsuarioConsumidor INT FOREIGN KEY REFERENCES Usuarios(IdUsuario),
    FechaOtorgamiento DATETIME2 DEFAULT GETDATE(),
    FechaExpiracion DATETIME2 NOT NULL
);

CREATE TABLE RegistroAccesos (
    IdAcceso INT PRIMARY KEY IDENTITY(1,1),
    IdUsuario INT FOREIGN KEY REFERENCES Usuarios(IdUsuario) ON DELETE CASCADE,
    IdVideo INT FOREIGN KEY REFERENCES Videos(IdVideo) ON DELETE CASCADE,
    FechaAcceso DATETIME2 DEFAULT GETDATE(),
    TipoAcceso NVARCHAR(50) NOT NULL
);
```

---

## ğŸ§ª Casos de Uso Completos

### Caso 1: Administrador Sube Video

```
Actores: AdminTest003
Precondiciones:
  â€¢ Usuario autenticado como Administrador
  â€¢ Archivo de video vÃ¡lido (MP4, â‰¤50MB)

Flujo:
1. Admin navega a /UploadVideo
2. Selecciona archivo "presentacion_empresa.mp4" (15 MB)
3. Ingresa tÃ­tulo: "PresentaciÃ³n Q4 2024"
4. Ingresa descripciÃ³n: "Resultados trimestrales confidenciales"
5. Hace clic en "Subir Video"

Sistema:
6. Valida archivo (tipo, tamaÃ±o)
7. Genera KEK aleatoria de 256 bits
8. Cifra video con ChaCha20-Poly1305
9. Cifra KEK con RSA-4096 del servidor
10. Calcula SHA-256 del original
11. Calcula HMAC del cifrado
12. Guarda archivo: Storage/Videos/{guid}.encrypted
13. INSERT INTO Videos + DatosCriptograficosVideos

Resultado:
  âœ… Video disponible en "Mis Videos"
  âœ… Datos criptogrÃ¡ficos almacenados
  âœ… Estado: "Disponible"
  âœ… TamaÃ±o: 15.7 MB (cifrado)
```

### Caso 2: Admin Otorga Permisos

```
Actores: AdminTest003
Precondiciones:
  â€¢ Video "PresentaciÃ³n Q4 2024" subido
  â€¢ Usuarios consumidores existen en DB

Flujo:
1. Admin navega a /ManagePermissions
2. Selecciona video "PresentaciÃ³n Q4 2024"
3. Selecciona usuarios: ConsumerTest001, ConsumerTest002
4. Establece expiraciÃ³n: 2025-12-31
5. Hace clic en "Otorgar Permisos"

Sistema:
6. Valida adminId es dueÃ±o del video
7. Valida usuarios son tipo "Consumidor"
8. Verifica permisos no existen
9. INSERT INTO Permisos (2 registros)

Resultado:
  âœ… ConsumerTest001 puede ver el video
  âœ… ConsumerTest002 puede ver el video
  âœ… Expiran el 31/12/2025
  âœ… Otros consumidores NO tienen acceso
```

### Caso 3: Consumidor Visualiza Video (Modelo de Claves EfÃ­meras)

```
Actores: ConsumerTest001
Precondiciones:
  â€¢ Usuario autenticado como Consumidor
  â€¢ Permiso activo para video #1

Flujo:
1. Consumer navega a /Home
2. Ve tarjeta de "PresentaciÃ³n Q4 2024"
3. Hace clic en "Ver Video"
4. Navegador redirige a /VideoPlayer?id=1

Cliente (JavaScript - Modelo de Claves EfÃ­meras):
5. ğŸ” Genera par RSA TEMPORAL (2048 bits) en RAM
   â€¢ window.crypto.subtle.generateKey()
   â€¢ Claves NUNCA se almacenan (ni localStorage ni archivo)
6. GET /api/videos/1/stream
   Authorization: Bearer {JWT-token}

Servidor:
7. Valida JWT y permiso existe y no expirÃ³
8. Query: SELECT KEKCifrado FROM DatosCriptograficosVideos
9. Descifra video completo con KEK del servidor
10. Retorna video descifrado por HTTPS

Cliente:
11. Recibe video descifrado
12. Crea Blob URL: URL.createObjectURL(videoBlob)
13. Asigna al <video> element
14. Reproduce con controles HTML5
15. ğŸ—‘ï¸ Al cerrar pestaÃ±a: destroyTemporaryKeys()
    â€¢ temporaryKeyPair = null
    â€¢ GC elimina claves de RAM

Sistema:
16. INSERT INTO RegistroAccesos (userId=ConsumerTest001, videoId=1)

Resultado:
  âœ… Video reproducido SIN almacenar claves en cliente
  âœ… Integridad garantizada por HTTPS
  âœ… Acceso registrado
  âœ… Claves temporales destruidas automÃ¡ticamente
  âœ… CERO riesgo de robo de claves privadas
  âœ… Funciona en cualquier dispositivo sin configuraciÃ³n
```

### Caso 4: Consumidor Sin Permiso Intenta Acceder

```
Actores: ConsumerTest003 (SIN permiso)
Precondiciones:
  â€¢ Usuario autenticado como Consumidor
  â€¢ NO tiene permiso para video #1

Flujo:
1. Consumer intenta acceder directamente: /VideoPlayer?id=1
2. Genera par RSA temporal
3. POST /VideoPlayer?handler=GetKeyPackage

Sistema:
4. Valida sesiÃ³n (OK)
5. Query: SELECT * FROM Permisos WHERE IdVideo=1 AND IdUsuarioConsumidor=ConsumerTest003
6. Resultado: NO EXISTE
7. THROW UnauthorizedAccessException

Resultado:
  âŒ Error: "Acceso denegado"
  âŒ No se distribuye KEK
  âŒ No se permite streaming
  âŒ Registro de intento fallido en logs
```

---

## ğŸ›¡ï¸ Modelo de Claves EfÃ­meras (Ephemeral Keys)

### âš ï¸ MEJORA CRÃTICA DE SEGURIDAD IMPLEMENTADA

El sistema ha migrado de un modelo de **claves persistentes con descarga manual** a un modelo de **claves efÃ­meras** para eliminar vulnerabilidades graves.

### âŒ Modelo Anterior (VULNERABLE)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  REGISTRO                                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Usuario se registra                                                     â”‚
â”‚  2. Sistema genera par RSA-2048                                             â”‚
â”‚  3. Clave privada cifrada con PBKDF2(password) â†’ localStorage               â”‚
â”‚  4. Usuario descarga clave privada en archivo JSON                          â”‚
â”‚                                                                             â”‚
â”‚  âŒ PROBLEMAS:                                                              â”‚
â”‚  â€¢ Archivo JSON contiene clave privada descifrada                           â”‚
â”‚  â€¢ Si el archivo se roba â†’ TODOS los videos comprometidos                   â”‚
â”‚  â€¢ localStorage vulnerable a XSS                                            â”‚
â”‚  â€¢ Usuario pierde archivo â†’ pierde acceso permanente                        â”‚
â”‚  â€¢ No hay recuperaciÃ³n posible                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### âœ… Modelo Actual (SEGURO)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  REGISTRO (Simplificado)                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Usuario se registra                                                     â”‚
â”‚  2. Sistema genera clave pÃºblica RSA para el servidor (opcional)            â”‚
â”‚  3. NO se genera ni almacena clave privada                                  â”‚
â”‚  4. NO hay descargas ni respaldos necesarios                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  REPRODUCCIÃ“N DE VIDEO (Claves EfÃ­meras)                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Usuario hace clic en "Ver Video"                                        â”‚
â”‚  2. JavaScript genera par RSA-2048 temporal en RAM:                         â”‚
â”‚     â€¢ window.crypto.subtle.generateKey()                                    â”‚
â”‚     â€¢ Propiedades: extractable=true, only in-memory                         â”‚
â”‚  3. Cliente solicita video con JWT                                          â”‚
â”‚  4. Servidor valida permisos y envÃ­a video descifrado                       â”‚
â”‚  5. Cliente reproduce video                                                 â”‚
â”‚  6. Al cerrar pestaÃ±a:                                                      â”‚
â”‚     â€¢ temporaryKeyPair = null                                               â”‚
â”‚     â€¢ Garbage Collector elimina claves de RAM                               â”‚
â”‚                                                                             â”‚
â”‚  âœ… VENTAJAS:                                                               â”‚
â”‚  â€¢ Zero-Storage: No hay archivos descargables                               â”‚
â”‚  â€¢ Zero-Persistence: No hay localStorage                                    â”‚
â”‚  â€¢ Auto-Destruction: Claves destruidas automÃ¡ticamente                      â”‚
â”‚  â€¢ Multi-Device: Funciona en cualquier dispositivo                          â”‚
â”‚  â€¢ Zero-Recovery-Risk: No hay claves que robar                              â”‚
â”‚  â€¢ GDPR Compliant: No se almacenan datos biomÃ©tricos                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ” GarantÃ­as de Seguridad

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GARANTÃA                        â”‚  IMPLEMENTACIÃ“N                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  No hay archivos robables        â”‚  NO se generan archivos JSON             â”‚
â”‚  No hay localStorage vulnerable  â”‚  NO se usa localStorage para claves      â”‚
â”‚  No hay persistencia             â”‚  Claves solo en memoria volÃ¡til (RAM)    â”‚
â”‚  No hay recuperaciÃ³n necesaria   â”‚  Claves se regeneran cada sesiÃ³n         â”‚
â”‚  No hay single point of failure  â”‚  Cada sesiÃ³n tiene claves Ãºnicas         â”‚
â”‚  No hay ataque offline posible   â”‚  No hay material para fuerza bruta       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“Š Comparativa de Seguridad

| Aspecto | Modelo Anterior | Modelo EfÃ­mero |
|---------|-----------------|----------------|
| **Archivo descargable** | âŒ SÃ­ (JSON con clave privada) | âœ… No existe |
| **localStorage** | âŒ Clave cifrada almacenada | âœ… No se usa |
| **Riesgo de robo** | âŒ Alto (archivo JSON) | âœ… Cero (no hay archivo) |
| **Portabilidad** | âŒ Depende de archivo | âœ… Cualquier dispositivo |
| **Usabilidad** | âŒ Compleja (descargar, guardar) | âœ… Simple (solo login) |
| **RecuperaciÃ³n** | âŒ Imposible si pierde archivo | âœ… No necesaria |
| **Conformidad GDPR** | âš ï¸ Cuestionable | âœ… Completa |
| **Zero-Knowledge** | âš ï¸ Parcial | âœ… Total |

---

## ğŸ›¡ï¸ Modelo de Claves EfÃ­meras (Ephemeral Keys Model)

### âš ï¸ MEJORA CRÃTICA DE SEGURIDAD IMPLEMENTADA

El sistema ha migrado de un modelo de **claves persistentes con descarga manual** a un modelo de **claves efÃ­meras zero-storage** para eliminar vulnerabilidades crÃ­ticas de robo de claves privadas.

### âŒ Modelo Anterior (VULNERABLE - DEPRECADO)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  REGISTRO (Modelo Anterior)                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Usuario se registra como consumidor                                     â”‚
â”‚  2. Sistema genera par RSA-2048                                             â”‚
â”‚  3. Clave privada cifrada con PBKDF2(password) â†’ localStorage               â”‚
â”‚  4. âŒ Usuario descarga clave privada en archivo JSON DESCIFRADO            â”‚
â”‚                                                                             â”‚
â”‚  âŒ PROBLEMAS CRÃTICOS:                                                     â”‚
â”‚  â€¢ Archivo JSON contiene clave privada en texto plano                       â”‚
â”‚  â€¢ Si el archivo se roba â†’ TODOS los videos comprometidos                   â”‚
â”‚  â€¢ localStorage vulnerable a ataques XSS                                    â”‚
â”‚  â€¢ Usuario pierde archivo â†’ pierde acceso permanente                        â”‚
â”‚  â€¢ No hay mecanismo de recuperaciÃ³n                                         â”‚
â”‚  â€¢ Riesgo de phishing para robar archivo                                    â”‚
â”‚  â€¢ Backups del archivo crean mÃºltiples vectores de ataque                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### âœ… Modelo Actual (SEGURO - IMPLEMENTADO)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  REGISTRO (Modelo Simplificado)                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Usuario se registra como consumidor                                     â”‚
â”‚  2. Sistema genera clave pÃºblica RSA para el servidor (opcional)            â”‚
â”‚  3. âœ… NO se genera ni almacena clave privada                               â”‚
â”‚  4. âœ… NO hay descargas ni respaldos necesarios                             â”‚
â”‚  5. âœ… Experiencia de usuario simplificada                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  REPRODUCCIÃ“N DE VIDEO (Claves EfÃ­meras)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Usuario hace clic en "Ver Video"                                        â”‚
â”‚  2. ğŸ” JavaScript genera par RSA-2048 TEMPORAL en memoria RAM:              â”‚
â”‚     â€¢ window.crypto.subtle.generateKey()                                    â”‚
â”‚     â€¢ Propiedades: extractable=true, uso: only in-memory                    â”‚
â”‚     â€¢ Tiempo de vida: duraciÃ³n de la sesiÃ³n de reproducciÃ³n                 â”‚
â”‚  3. Cliente solicita video con JWT Bearer token                             â”‚
â”‚  4. Servidor valida permisos y devuelve video descifrado                    â”‚
â”‚  5. Cliente reproduce video con <video> HTML5                               â”‚
â”‚  6. ğŸ—‘ï¸ Al cerrar pestaÃ±a o terminar reproducciÃ³n:                          â”‚
â”‚     â€¢ temporaryKeyPair = null                                               â”‚
â”‚     â€¢ temporaryPrivateKey = null                                            â”‚
â”‚     â€¢ JavaScript Garbage Collector elimina objetos de RAM                   â”‚
â”‚                                                                             â”‚
â”‚  âœ… VENTAJAS DE SEGURIDAD:                                                  â”‚
â”‚  â€¢ Zero-Storage: No hay archivos descargables vulnerables                   â”‚
â”‚  â€¢ Zero-Persistence: No hay localStorage ni cookies con claves              â”‚
â”‚  â€¢ Auto-Destruction: GC destruye claves automÃ¡ticamente                     â”‚
â”‚  â€¢ True Zero-Knowledge: Servidor nunca conoce clave privada temporal        â”‚
â”‚  â€¢ Multi-Device: Funciona en cualquier dispositivo sin configuraciÃ³n        â”‚
â”‚  â€¢ Zero-Recovery-Risk: No hay material criptogrÃ¡fico que robar              â”‚
â”‚  â€¢ GDPR Compliant: No se almacenan datos biomÃ©tricos del usuario            â”‚
â”‚  â€¢ Portabilidad total: Mismo flujo en desktop, mobile, tablet               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ” GarantÃ­as de Seguridad del Modelo EfÃ­mero

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GARANTÃA                        â”‚  IMPLEMENTACIÃ“N                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  No hay archivos robables        â”‚  NO se generan archivos JSON             â”‚
â”‚  No hay localStorage vulnerable  â”‚  NO se usa localStorage para claves      â”‚
â”‚  No hay persistencia de claves   â”‚  Claves solo en memoria volÃ¡til (RAM)    â”‚
â”‚  No hay recuperaciÃ³n necesaria   â”‚  Claves se regeneran cada sesiÃ³n         â”‚
â”‚  No hay single point of failure  â”‚  Cada sesiÃ³n tiene claves Ãºnicas         â”‚
â”‚  No hay ataque offline posible   â”‚  No hay material para fuerza bruta       â”‚
â”‚  No hay phishing de claves       â”‚  No hay claves que solicitar al usuario  â”‚
â”‚  No hay XSS que robar claves     â”‚  Claves nunca en localStorage/cookies    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“Š Comparativa de Modelos de Seguridad

| Aspecto | Modelo Anterior (Persistente) | Modelo EfÃ­mero (Actual) |
|---------|-------------------------------|-------------------------|
| **Archivo descargable** | âŒ SÃ­ (JSON con clave privada) | âœ… No existe |
| **localStorage** | âŒ Clave cifrada almacenada | âœ… No se usa para claves |
| **Riesgo de robo** | âŒ Alto (archivo JSON vulnerable) | âœ… Cero (no hay archivo) |
| **Riesgo XSS** | âŒ Alto (localStorage) | âœ… MÃ­nimo (solo JWT) |
| **Portabilidad** | âŒ Depende de archivo respaldo | âœ… Cualquier dispositivo |
| **Usabilidad** | âŒ Compleja (descargar, guardar) | âœ… Simple (solo login) |
| **RecuperaciÃ³n** | âŒ Imposible si pierde archivo | âœ… No necesaria |
| **GestiÃ³n de backups** | âŒ Usuario responsable | âœ… No aplica |
| **Conformidad GDPR** | âš ï¸ Cuestionable (datos biomÃ©tricos) | âœ… Completa |
| **Zero-Knowledge** | âš ï¸ Parcial | âœ… Total |
| **Superficie de ataque** | âŒ Grande (archivo + localStorage) | âœ… MÃ­nima (solo sesiÃ³n) |
| **Tiempo de vida clave** | âŒ Permanente hasta rotaciÃ³n | âœ… Solo duraciÃ³n del video |

### ğŸ”„ Ciclo de Vida de Claves EfÃ­meras

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   INICIO SESIÃ“N                REPRODUCCIÃ“N                FIN SESIÃ“N      â”‚
â”‚        â”‚                             â”‚                          â”‚           â”‚
â”‚        â–¼                             â–¼                          â–¼           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚ Usuario â”‚                  â”‚Claves   â”‚                â”‚  GC     â”‚     â”‚
â”‚   â”‚ Login   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚Temp.    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚Destruye â”‚     â”‚
â”‚   â”‚ JWT     â”‚  Genera RSA-2048 â”‚En RAM   â”‚ Cierra pestaÃ±a â”‚ Claves  â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚       0s                         0-5s                        Inmediato     â”‚
â”‚                                                                             â”‚
â”‚  â€¢ GeneraciÃ³n: Web Crypto API (~1-2 segundos para RSA-2048)                â”‚
â”‚  â€¢ Uso: Solo durante reproducciÃ³n del video                                â”‚
â”‚  â€¢ DestrucciÃ³n: AutomÃ¡tica al cerrar tab o finalizar video                 â”‚
â”‚  â€¢ Memoria: ~2KB por par de claves (despreciable)                          â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ’¡ ImplementaciÃ³n TÃ©cnica

```javascript
// video-decryption-simplified.js

// 1. GeneraciÃ³n de claves temporales (solo en RAM)
temporaryKeyPair = await window.crypto.subtle.generateKey(
    {
        name: "RSA-OAEP",
        modulusLength: 2048,
        publicExponent: new Uint8Array([1, 0, 1]),
        hash: "SHA-256"
    },
    true,  // extractable (para exportar solo publicKey)
    ["encrypt", "decrypt"]
);

// 2. Exportar solo clave pÃºblica para enviar al servidor (si fuera necesario)
temporaryPublicKeyPem = await exportPublicKeyToPem(temporaryKeyPair.publicKey);

// 3. Usar claves durante reproducciÃ³n
// (En el modelo actual, el servidor descifra el video)

// 4. DestrucciÃ³n explÃ­cita al cerrar
function destroyTemporaryKeys() {
    temporaryKeyPair = null;
    temporaryPrivateKey = null;
    temporaryPublicKeyPem = null;
    
    // Forzar GC si estÃ¡ disponible (solo en entornos de desarrollo)
    if (typeof window.gc === 'function') {
        window.gc();
    }
}

// Event listeners para limpieza automÃ¡tica
window.addEventListener('beforeunload', destroyTemporaryKeys);
videoPlayer.addEventListener('ended', destroyTemporaryKeys);
```

### ğŸ¯ Ventajas del Modelo EfÃ­mero vs Alternativas

| CaracterÃ­stica | Claves EfÃ­meras | Claves en Servidor | Claves Persistentes |
|----------------|-----------------|--------------------|--------------------|
| **Seguridad KEK** | âœ… Alta | âœ… Alta | âŒ Baja |
| **Riesgo robo cliente** | âœ… Cero | âœ… Cero | âŒ Alto |
| **Portabilidad** | âœ… Total | âœ… Total | âŒ Limitada |
| **Zero-Knowledge** | âœ… SÃ­ | âŒ No | âš ï¸ Parcial |
| **Usabilidad** | âœ… Simple | âœ… Simple | âŒ Compleja |
| **Carga servidor** | âœ… Baja | âš ï¸ Media | âœ… Baja |
| **Escalabilidad** | âœ… Alta | âš ï¸ Media | âœ… Alta |
| **Costo operacional** | âœ… Bajo | âš ï¸ Medio | âœ… Bajo |
| **Conformidad regulatoria** | âœ… Total | âœ… Total | âš ï¸ Cuestionable |

---

## ğŸ” Patrones de DiseÃ±o Utilizados

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PATRÃ“N                     â”‚  UBICACIÃ“N                â”‚  PROPÃ“SITO        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Repository Pattern         â”‚  ApplicationDbContext     â”‚  AbstracciÃ³n DB   â”‚
â”‚  Dependency Injection       â”‚  ServiceExtensions.cs     â”‚  Desacoplamiento  â”‚
â”‚  Strategy Pattern           â”‚  Cryptography Services    â”‚  Algoritmos       â”‚
â”‚  Factory Pattern            â”‚  Key generation services  â”‚  CreaciÃ³n objetos â”‚
â”‚  Middleware Pattern         â”‚  ErrorHandlingMiddleware  â”‚  Pipeline HTTP    â”‚
â”‚  DTO Pattern                â”‚  Models/DTOs              â”‚  Data Transfer    â”‚
â”‚  Service Layer Pattern      â”‚  Business/Services        â”‚  LÃ³gica negocio   â”‚
â”‚  CQRS (parcial)             â”‚  SeparaciÃ³n Read/Write    â”‚  Escalabilidad    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ›¡ï¸ AnÃ¡lisis de Amenazas y Mitigaciones

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AMENAZA                          â”‚  MITIGACIÃ“N IMPLEMENTADA                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Man-in-the-Middle (MITM)        â”‚  â€¢ HTTPS obligatorio (TLS 1.2+)         â”‚
â”‚                                   â”‚  â€¢ JWT firmado con HMAC-SHA256          â”‚
â”‚                                   â”‚  â€¢ KEK re-cifrada con RSA temporal      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Ataques de Fuerza Bruta         â”‚  â€¢ PBKDF2 con 100K iteraciones          â”‚
â”‚                                   â”‚  â€¢ Salt Ãºnico por usuario               â”‚
â”‚                                   â”‚  â€¢ Bloqueo despuÃ©s de N intentos (TODO) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Robo de KEK o Claves Privadas   â”‚  â€¢ KEK nunca en texto plano en DB       â”‚
â”‚                                   â”‚  â€¢ âœ… Claves RSA temporales (solo RAM)   â”‚
â”‚                                   â”‚  â€¢ âœ… NO se almacenan claves privadas    â”‚
â”‚                                   â”‚  â€¢ âœ… NO hay archivos descargables       â”‚
â”‚                                   â”‚  â€¢ âœ… DestrucciÃ³n automÃ¡tica al cerrar   â”‚
â”‚                                   â”‚  â€¢ Clave servidor cifrada con AES-256   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ManipulaciÃ³n de Video Cifrado   â”‚  â€¢ Poly1305 AuthTag (128 bits)          â”‚
â”‚                                   â”‚  â€¢ HMAC-SHA256 del archivo completo     â”‚
â”‚                                   â”‚  â€¢ VerificaciÃ³n de integridad SHA-256   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Acceso No Autorizado             â”‚  â€¢ RBAC (Roles)                         â”‚
â”‚                                   â”‚  â€¢ Permisos granulares por video        â”‚
â”‚                                   â”‚  â€¢ ValidaciÃ³n en mÃºltiples capas        â”‚
â”‚                                   â”‚  â€¢ Token expiration                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Replay Attacks                   â”‚  â€¢ Nonce Ãºnico por video                â”‚
â”‚                                   â”‚  â€¢ Timestamp en JWT                     â”‚
â”‚                                   â”‚  â€¢ Claves temporales desechables        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  SQL Injection                    â”‚  â€¢ Entity Framework (parametrizado)     â”‚
â”‚                                   â”‚  â€¢ ValidaciÃ³n de inputs                 â”‚
â”‚                                   â”‚  â€¢ Stored procedures (donde aplique)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  XSS (Cross-Site Scripting)       â”‚  â€¢ Razor auto-encoding                  â”‚
â”‚                                   â”‚  â€¢ Content Security Policy              â”‚
â”‚                                   â”‚  â€¢ Input sanitization                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  CSRF (Cross-Site Request Forgeryâ”‚  â€¢ AntiForgeryToken en formularios      â”‚
â”‚                                   â”‚  â€¢ SameSite cookies                     â”‚
â”‚                                   â”‚  â€¢ Origin validation                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ˆ Rendimiento y Escalabilidad

### Optimizaciones Actuales

```
â€¢ Streaming por chunks (80KB): Reduce uso de memoria
â€¢ FileStream con buffering: Evita cargar videos completos
â€¢ Range requests (HTTP 206): Soporte para seek en reproductor
â€¢ Singleton para servicios criptogrÃ¡ficos: ReutilizaciÃ³n de instancias
â€¢ Ãndices en DB: IdVideo, IdUsuario, FechaExpiracion en Permisos
â€¢ Connection pooling: MultipleActiveResultSets=true
```

### Puntos de Mejora (TODO)

```
âŒ Caching de Key Packages (Redis)
âŒ CDN para distribuciÃ³n de videos cifrados
âŒ Thumbnail generation asÃ­ncrona (Background jobs)
âŒ Video transcoding a mÃºltiples resoluciones
âŒ Load balancing para streaming
âŒ Database read replicas
âŒ Compression de videos antes de cifrado
```

---

## ğŸš€ Roadmap de Funcionalidades

### Fase 1: Actual (Completado)
- [x] AutenticaciÃ³n JWT + Session
- [x] Subida y cifrado de videos
- [x] GestiÃ³n de permisos
- [x] DistribuciÃ³n segura de claves
- [x] Streaming y reproducciÃ³n
- [x] Dashboard por rol
- [x] AuditorÃ­a de accesos

### Fase 2: Corto Plazo
- [ ] GestiÃ³n de perfiles de usuario
- [ ] Notificaciones de permisos otorgados
- [ ] BÃºsqueda y filtrado avanzado
- [ ] ExportaciÃ³n de logs de auditorÃ­a
- [ ] Two-Factor Authentication (2FA)
- [ ] Rate limiting para API

### Fase 3: Mediano Plazo
- [ ] Streaming adaptativo (HLS/DASH)
- [ ] Soporte para mÃºltiples formatos
- [ ] Anotaciones en videos
- [ ] Compartir videos con links temporales
- [ ] IntegraciÃ³n con Azure Storage
- [ ] Mobile apps (iOS/Android)

### Fase 4: Largo Plazo
- [ ] Machine Learning para detecciÃ³n de contenido
- [ ] Watermarking dinÃ¡mico por usuario
- [ ] Blockchain para trazabilidad
- [ ] Federated learning para anÃ¡lisis
- [ ] Quantum-resistant cryptography
- [ ] End-to-end encryption en grupos

---

## ğŸ“š Referencias y DocumentaciÃ³n

### Algoritmos CriptogrÃ¡ficos

```
â€¢ ChaCha20-Poly1305: RFC 8439
  https://datatracker.ietf.org/doc/html/rfc8439

â€¢ RSA-OAEP: PKCS #1 v2.2
  https://datatracker.ietf.org/doc/html/rfc8017

â€¢ PBKDF2: RFC 2898
  https://datatracker.ietf.org/doc/html/rfc2898

â€¢ HMAC-SHA256: FIPS 198-1
  https://csrc.nist.gov/publications/detail/fips/198/1/final

â€¢ SHA-3 (KMAC256): NIST FIPS 202
  https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.202.pdf
```

### LibrerÃ­as Utilizadas

```
â€¢ NSec.Cryptography (v23.1.0): ChaCha20-Poly1305, HMAC, SHA-256
â€¢ System.Security.Cryptography: RSA, PBKDF2
â€¢ Microsoft.EntityFrameworkCore (v8.0): ORM
â€¢ Microsoft.AspNetCore.Authentication.JwtBearer (v8.0): JWT Auth
â€¢ libsodium.js (cliente): Descifrado en navegador
```

### EstÃ¡ndares de Seguridad

```
â€¢ OWASP Top 10 (2021): GuÃ­a de vulnerabilidades
â€¢ NIST SP 800-175B: Cryptographic Algorithm Validation
â€¢ ISO/IEC 27001: Information Security Management
â€¢ GDPR: ProtecciÃ³n de datos personales (parcialmente aplicable)
```

---

## ğŸ ConclusiÃ³n

Este sistema implementa un enfoque de **Zero-Trust Security** para la distribuciÃ³n de videos confidenciales:

âœ… **Cifrado extremo a extremo**: Video nunca almacenado en claro
âœ… **SeparaciÃ³n de privilegios**: Admin vs Consumer roles
âœ… **Permisos granulares**: Control por video y usuario
âœ… **Auditabilidad completa**: Registro de todos los accesos
âœ… **CriptografÃ­a moderna**: ChaCha20-Poly1305 + RSA-4096
âœ… **Defensa en profundidad**: 6 capas de seguridad concÃ©ntricas

El sistema es **production-ready** para entornos que requieren mÃ¡xima confidencialidad, como:
- Videos corporativos confidenciales
- Material educativo restringido
- Documentales con derechos exclusivos
- Pruebas forenses digitales
- Comunicaciones gubernamentales

---

**Ãšltima actualizaciÃ³n**: 2025
**VersiÃ³n del sistema**: 1.0.0
**Framework**: ASP.NET Core 8.0
**Base de datos**: SQL Server Express 2022
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             KeyDistributionService                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  2. Validar Permiso                                        â”‚
â”‚     â†“                                                       â”‚
â”‚  PermissionService.CheckPermissionAsync(videoId, userId)   â”‚
â”‚     â†“                                                       â”‚
â”‚  âœ… Permiso Activo                                         â”‚
â”‚     â”‚                                                       â”‚
â”‚     â†“                                                       â”‚
â”‚  3. Obtener Datos Video                                    â”‚
â”‚     â†“                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  Video                                       â”‚          â”‚
â”‚  â”‚  â”œâ”€â”€ IdVideo: 1                             â”‚          â”‚
â”‚  â”‚  â”œâ”€â”€ TituloVideo: "Mi Video"                â”‚          â”‚
â”‚  â”‚  â””â”€â”€ DatosCriptograficos                    â”‚          â”‚
â”‚  â”‚      â”œâ”€â”€ KEKCifrada (con RSA servidor)      â”‚          â”‚
â”‚  â”‚      â”œâ”€â”€ Nonce                               â”‚          â”‚
â”‚  â”‚      â”œâ”€â”€ AuthTag                             â”‚          â”‚
â”‚  â”‚      â”œâ”€â”€ HashSHA256Original                  â”‚          â”‚
â”‚  â”‚      â””â”€â”€ HMACDelVideo                        â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚     â”‚                                                       â”‚
â”‚     â†“                                                       â”‚
â”‚  4. Descifrar KEK con Clave Privada Servidor              â”‚
â”‚     â†“                                                       â”‚
â”‚  RsaService.Decrypt(                                       â”‚
â”‚      data: KEKCifrada,                                     â”‚
â”‚      privateKey: Storage/Keys/server_private_key.pem       â”‚
â”‚  )                                                          â”‚
â”‚     â†“                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚  â”‚  KEK (32 bytes)  â”‚ â† Clave simÃ©trica en claro          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚     â”‚                                                       â”‚
â”‚     â†“                                                       â”‚
â”‚  5. Re-cifrar KEK con Clave PÃºblica del Usuario           â”‚
â”‚     â†“                                                       â”‚
â”‚  RsaService.Encrypt(                                       â”‚
â”‚      data: KEK,                                            â”‚
â”‚      publicKey: usuario.ClavePublicaRSA                    â”‚
â”‚  )                                                          â”‚
â”‚     â†“                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚  â”‚  KEKCifradaParaUsuario     â”‚ â† Solo el usuario puede   â”‚
â”‚  â”‚  (cifrada con su RSA)      â”‚   descifrarla             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚     â”‚                                                       â”‚
â”‚     â†“                                                       â”‚
â”‚  6. Construir Response                                     â”‚
â”‚     â†“                                                       â”‚
â”‚  7. Incrementar Contador de Accesos                       â”‚
â”‚     â†“                                                       â”‚
â”‚  8. Registrar en RegistroAccesos                          â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              KeyDistributionResponse                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  {                                                       â”‚
â”‚    "idVideo": 1,                                        â”‚
â”‚    "tituloVideo": "Mi Video",                           â”‚
â”‚    "kekCifradaParaUsuario": "BASE64...",  â† RSA usuarioâ”‚
â”‚    "nonce": "BASE64...",                                â”‚
â”‚    "authTag": "BASE64...",                              â”‚
â”‚    "hashOriginal": "BASE64...",                         â”‚
â”‚    "hmac": "BASE64...",                                 â”‚
â”‚    "algoritmoCifrado": "ChaCha20-Poly1305",            â”‚
â”‚    "videoDownloadUrl": "/api/videos/1/download",       â”‚
â”‚    "tamaÃ±oArchivo": 1234567,                           â”‚
â”‚    "fechaGeneracion": "2025-11-23T..."                 â”‚
â”‚  }                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Usuario  â”‚  9. Recibe claves
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cliente (prÃ³xima implementaciÃ³n)              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”‚
â”‚  1. Descifra KEK con su clave privada RSA     â”‚
â”‚  2. Descarga video cifrado                     â”‚
â”‚  3. Descifra video con ChaCha20 usando KEK     â”‚
â”‚  4. Verifica integridad (SHA-256 + HMAC)       â”‚
â”‚  5. Reproduce video original                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Capas de Seguridad

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CAPA 1: AutenticaciÃ³n                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                  â”‚
â”‚  â€¢ JWT Token con expiraciÃ³n                             â”‚
â”‚  â€¢ PBKDF2 (100K iteraciones)                            â”‚
â”‚  â€¢ Salt Ãºnico por usuario                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CAPA 2: AutorizaciÃ³n                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                   â”‚
â”‚  â€¢ Roles (Administrador / Usuario)                      â”‚
â”‚  â€¢ [Authorize] en controllers                           â”‚
â”‚  â€¢ ValidaciÃ³n de ownership                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CAPA 3: Permisos Granulares                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                â”‚
â”‚  â€¢ Por video y usuario                                  â”‚
â”‚  â€¢ Temporal o permanente                                â”‚
â”‚  â€¢ RevocaciÃ³n instantÃ¡nea                               â”‚
â”‚  â€¢ ValidaciÃ³n de expiraciÃ³n                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CAPA 4: DistribuciÃ³n de Claves                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                             â”‚
â”‚  â€¢ Re-cifrado con RSA del usuario                       â”‚
â”‚  â€¢ Claves solo para usuarios autorizados                â”‚
â”‚  â€¢ AuditorÃ­a de cada solicitud                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CAPA 5: Cifrado de Video                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                   â”‚
â”‚  â€¢ ChaCha20-Poly1305 (AEAD)                             â”‚
â”‚  â€¢ KEK Ãºnica por video                                  â”‚
â”‚  â€¢ Nonce Ãºnico                                          â”‚
â”‚  â€¢ AuthTag para autenticaciÃ³n                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CAPA 6: Integridad                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                     â”‚
â”‚  â€¢ SHA-256 del original                                 â”‚
â”‚  â€¢ HMAC del cifrado                                     â”‚
â”‚  â€¢ Poly1305 AuthTag                                     â”‚
â”‚  â€¢ Triple verificaciÃ³n                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š EstadÃ­sticas del Sistema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        COMPONENTES IMPLEMENTADOS         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Controllers:             6              â”‚
â”‚  Business Services:       6              â”‚
â”‚  Crypto Services:         4              â”‚
â”‚  Entities:                6              â”‚
â”‚  DTOs:                   12+             â”‚
â”‚  API Endpoints:          25+             â”‚
â”‚  LÃ­neas de CÃ³digo:    8,000+            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           COBERTURA FUNCIONAL            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  AutenticaciÃ³n:         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%   â”‚
â”‚  AutorizaciÃ³n:          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%   â”‚
â”‚  Cifrado Videos:        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%   â”‚
â”‚  GestiÃ³n Permisos:      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%   â”‚
â”‚  Grid Videos:           â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%   â”‚
â”‚  DistribuciÃ³n Claves:   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%   â”‚
â”‚  Download/Stream:       â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   0%   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Endpoints API

```
Authentication
â”œâ”€â”€ POST   /api/auth/register
â”œâ”€â”€ POST   /api/auth/login
â””â”€â”€ GET    /api/auth/me

Users
â”œâ”€â”€ GET    /api/users
â”œâ”€â”€ GET    /api/users/{id}
â”œâ”€â”€ PUT    /api/users/{id}
â””â”€â”€ DELETE /api/users/{id}

Videos
â”œâ”€â”€ GET    /api/videos
â”œâ”€â”€ GET    /api/videos/{id}
â”œâ”€â”€ GET    /api/videos/admin/{adminId}
â”œâ”€â”€ POST   /api/videos/upload
â””â”€â”€ DELETE /api/videos/{id}

Permissions ğŸ†•
â”œâ”€â”€ POST   /api/permissions/grant
â”œâ”€â”€ DELETE /api/permissions/{id}
â”œâ”€â”€ GET    /api/permissions/check
â”œâ”€â”€ GET    /api/permissions/video/{videoId}
â”œâ”€â”€ GET    /api/permissions/my-permissions
â”œâ”€â”€ PUT    /api/permissions/{id}/extend
â””â”€â”€ GET    /api/permissions/{id}

Video Grid ğŸ†•
â”œâ”€â”€ GET    /api/videogrid
â”œâ”€â”€ GET    /api/videogrid/search
â””â”€â”€ GET    /api/videogrid/{videoId}

Key Distribution ğŸ†•
â”œâ”€â”€ GET    /api/keydistribution/request/{videoId}
â””â”€â”€ GET    /api/keydistribution/validate/{videoId}

Health
â””â”€â”€ GET    /api/health
```

---

**Estado:** âœ… Entregable 2 Completo - Sistema Funcional al 90%
