@page
@model SecureVideoStreaming.API.Pages.VideoGridModel
@{
    ViewData["Title"] = "Galer√≠a de Videos";
}

<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="display-4">
                <i class="bi bi-collection-play"></i> Galer√≠a de Videos
            </h1>
            <p class="text-muted">Explora los videos disponibles y solicita acceso</p>
        </div>
        <div class="col-md-4 text-end">
            @if (User.Identity?.IsAuthenticated == true)
            {
                <span class="badge bg-success fs-6">
                    <i class="bi bi-person-check"></i> @User.Identity.Name
                </span>
            }
        </div>
    </div>

    <!-- Filtros de b√∫squeda -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-4">
                    <label class="form-label"><i class="bi bi-search"></i> Buscar</label>
                    <input type="text" class="form-control" name="searchTerm" 
                           value="@Model.SearchTerm" placeholder="T√≠tulo o administrador...">
                </div>
                <div class="col-md-3">
                    <label class="form-label"><i class="bi bi-funnel"></i> Estado de Permiso</label>
                    <select class="form-select" name="permissionStatus">
                        <option value="">Todos</option>
                        <option value="Activo" selected="@(Model.PermissionStatus == "Activo")">‚úÖ Activo</option>
                        <option value="Expirado" selected="@(Model.PermissionStatus == "Expirado")">‚ö†Ô∏è Expirado</option>
                        <option value="Sin Permiso" selected="@(Model.PermissionStatus == "Sin Permiso")">üîí Sin Permiso</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label"><i class="bi bi-person"></i> Administrador</label>
                    <input type="text" class="form-control" name="adminName" 
                           value="@Model.AdminName" placeholder="Nombre del admin...">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search"></i> Buscar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Estad√≠sticas r√°pidas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-bg-primary shadow-sm">
                <div class="card-body text-center">
                    <h3 class="mb-0">@Model.Videos.Count</h3>
                    <small>Videos Totales</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-bg-success shadow-sm">
                <div class="card-body text-center">
                    <h3 class="mb-0">@Model.Videos.Count(v => v.EstadoPermiso == "Activo")</h3>
                    <small>Con Acceso</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-bg-warning shadow-sm">
                <div class="card-body text-center">
                    <h3 class="mb-0">@Model.Videos.Count(v => v.EstadoPermiso == "Expirado")</h3>
                    <small>Expirados</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-bg-danger shadow-sm">
                <div class="card-body text-center">
                    <h3 class="mb-0">@Model.Videos.Count(v => v.EstadoPermiso == "Sin Permiso")</h3>
                    <small>Sin Permiso</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Grid de Videos -->
    @if (!Model.Videos.Any())
    {
        <div class="alert alert-info text-center py-5">
            <i class="bi bi-inbox fs-1"></i>
            <h4 class="mt-3">No hay videos disponibles</h4>
            <p class="text-muted">No se encontraron videos con los filtros aplicados</p>
        </div>
    }
    else
    {
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            @foreach (var video in Model.Videos)
            {
                <div class="col">
                    <div class="card h-100 shadow-sm hover-shadow">
                        <!-- Badge de estado -->
                        <div class="position-absolute top-0 end-0 m-2">
                            @if (video.EstadoPermiso == "Activo")
                            {
                                <span class="badge bg-success">
                                    <i class="bi bi-check-circle"></i> Activo
                                </span>
                            }
                            else if (video.EstadoPermiso == "Expirado")
                            {
                                <span class="badge bg-warning">
                                    <i class="bi bi-exclamation-triangle"></i> Expirado
                                </span>
                            }
                            else
                            {
                                <span class="badge bg-danger">
                                    <i class="bi bi-lock"></i> Sin Permiso
                                </span>
                            }
                        </div>

                        <!-- Thumbnail simulado -->
                        <div class="card-img-top bg-gradient d-flex align-items-center justify-content-center" 
                             style="height: 180px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <i class="bi bi-play-circle text-white" style="font-size: 4rem; opacity: 0.9;"></i>
                        </div>

                        <div class="card-body">
                            <h5 class="card-title text-truncate" title="@video.TituloVideo">
                                @video.TituloVideo
                            </h5>
                            <p class="card-text text-muted small mb-2">
                                <i class="bi bi-person"></i> @video.NombreAdministrador
                            </p>
                            
                            <!-- Informaci√≥n t√©cnica -->
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <small class="text-muted">
                                        <i class="bi bi-hdd"></i> @video.Tama√±oArchivoFormateado
                                    </small>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">
                                        <i class="bi bi-clock"></i> @video.DuracionFormateada
                                    </small>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">
                                        <i class="bi bi-shield-check"></i> ChaCha20-Poly1305
                                    </small>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">
                                        <i class="bi bi-calendar"></i> @video.FechaSubida.ToString("dd/MM/yyyy")
                                    </small>
                                </div>
                            </div>

                            <!-- Informaci√≥n de permiso -->
                            @if (video.TienePermiso)
                            {
                                <div class="alert alert-success py-2 mb-2">
                                    <small>
                                        <i class="bi bi-key"></i> 
                                        Otorgado: @video.FechaOtorgamiento?.ToString("dd/MM/yyyy")
                                    </small>
                                    @if (video.FechaExpiracion.HasValue)
                                    {
                                        <br/>
                                        <small>
                                            <i class="bi bi-hourglass"></i> 
                                            Expira: @video.FechaExpiracion.Value.ToString("dd/MM/yyyy HH:mm")
                                        </small>
                                    }
                                </div>
                            }

                            <!-- Botones de acci√≥n -->
                            <div class="d-grid gap-2">
                                @if (video.PermiteVisualizacion)
                                {
                                    <a href="/api/keydistribution/request/@video.IdVideo" 
                                       class="btn btn-success btn-sm">
                                        <i class="bi bi-key-fill"></i> Solicitar Claves
                                    </a>
                                    <button class="btn btn-primary btn-sm" 
                                            onclick="verDetalles(@video.IdVideo)">
                                        <i class="bi bi-play-fill"></i> Ver Video
                                    </button>
                                }
                                else if (video.EstadoPermiso == "Expirado")
                                {
                                    <button class="btn btn-warning btn-sm" disabled>
                                        <i class="bi bi-exclamation-triangle"></i> Permiso Expirado
                                    </button>
                                }
                                else
                                {
                                    <button class="btn btn-secondary btn-sm" disabled>
                                        <i class="bi bi-lock"></i> Sin Acceso
                                    </button>
                                }
                                <button class="btn btn-outline-info btn-sm" 
                                        onclick="verInfo(@video.IdVideo)">
                                    <i class="bi bi-info-circle"></i> Ver Detalles
                                </button>
                            </div>
                        </div>

                        <!-- Footer con estad√≠sticas -->
                        @if (video.TienePermiso && video.NumeroAccesos > 0)
                        {
                            <div class="card-footer text-muted small">
                                <i class="bi bi-eye"></i> @video.NumeroAccesos visualizaciones
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    }
</div>

<!-- Modal de detalles -->
<div class="modal fade" id="modalDetalles" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-info-circle"></i> Detalles del Video
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalDetallesContenido">
                <div class="text-center py-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .hover-shadow {
            transition: all 0.3s ease;
        }
        .hover-shadow:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
        }
        .bg-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-img-top i {
            transition: all 0.3s ease;
        }
        .card:hover .card-img-top i {
            transform: scale(1.2);
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
}

@section Scripts {
    <script>
        async function verDetalles(videoId) {
            alert('üé¨ Funcionalidad de reproducci√≥n pendiente de implementar en Entregable 3\n\nPor ahora, puedes solicitar las claves desde el bot√≥n "Solicitar Claves"');
        }

        async function verInfo(videoId) {
            const modal = new bootstrap.Modal(document.getElementById('modalDetalles'));
            const contenido = document.getElementById('modalDetallesContenido');
            
            modal.show();
            
            try {
                const response = await fetch(`/api/videogrid/${videoId}`, {
                    headers: {
                        'Authorization': 'Bearer ' + sessionStorage.getItem('token')
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Error al cargar detalles');
                }
                
                const data = await response.json();
                const video = data.data;
                
                contenido.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="bi bi-film"></i> Informaci√≥n del Video</h6>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item"><strong>T√≠tulo:</strong> ${video.tituloVideo}</li>
                                <li class="list-group-item"><strong>Administrador:</strong> ${video.nombreAdministrador}</li>
                                <li class="list-group-item"><strong>Tama√±o:</strong> ${video.tama√±oArchivoFormateado}</li>
                                <li class="list-group-item"><strong>Duraci√≥n:</strong> ${video.duracionFormateada}</li>
                                <li class="list-group-item"><strong>Formato:</strong> ${video.formatoVideo}</li>
                                <li class="list-group-item"><strong>Subido:</strong> ${new Date(video.fechaSubida).toLocaleString('es-MX')}</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="bi bi-shield-check"></i> Informaci√≥n de Seguridad</h6>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item"><strong>Algoritmo:</strong> ChaCha20-Poly1305</li>
                                <li class="list-group-item"><strong>Estado:</strong> 
                                    <span class="badge bg-${video.estadoPermiso === 'Activo' ? 'success' : video.estadoPermiso === 'Expirado' ? 'warning' : 'danger'}">
                                        ${video.estadoPermiso}
                                    </span>
                                </li>
                                <li class="list-group-item"><strong>Accesos:</strong> ${video.numeroAccesos || 0}</li>
                                ${video.tienePermiso ? `
                                    <li class="list-group-item"><strong>Permiso desde:</strong> ${new Date(video.fechaOtorgamiento).toLocaleDateString('es-MX')}</li>
                                    ${video.fechaExpiracion ? `<li class="list-group-item"><strong>Expira:</strong> ${new Date(video.fechaExpiracion).toLocaleString('es-MX')}</li>` : '<li class="list-group-item"><strong>Tipo:</strong> Permanente</li>'}
                                ` : ''}
                            </ul>
                        </div>
                    </div>
                    ${video.permiteVisualizacion ? `
                        <div class="alert alert-success mt-3">
                            <i class="bi bi-check-circle"></i> Tienes permiso para ver este video
                        </div>
                    ` : `
                        <div class="alert alert-warning mt-3">
                            <i class="bi bi-lock"></i> No tienes permiso para ver este video. Contacta al administrador.
                        </div>
                    `}
                `;
            } catch (error) {
                contenido.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> Error al cargar los detalles del video
                    </div>
                `;
            }
        }
    </script>
}
