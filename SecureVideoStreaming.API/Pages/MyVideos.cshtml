@page
@model SecureVideoStreaming.API.Pages.MyVideosModel
@{
    ViewData["Title"] = "Mis Videos";
}

<div class="container-fluid py-4">
    <!-- Encabezado -->
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-3">
                <i class="bi bi-camera-video me-2"></i>Mis Videos
            </h2>
            <p class="text-muted">Gestiona todos los videos que has subido a la plataforma</p>
        </div>
    </div>

    <!-- Tarjetas de Estadísticas -->
    <div class="row mb-4">
        <div class="col-md-4 mb-3">
            <div class="card border-primary">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Total de Videos</h6>
                            <h3 class="mb-0 text-primary">@Model.TotalVideos</h3>
                        </div>
                        <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                            <i class="bi bi-collection-play fs-3 text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4 mb-3">
            <div class="card border-info">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Almacenamiento Usado</h6>
                            <h3 class="mb-0 text-info">@Model.TotalAlmacenamiento</h3>
                        </div>
                        <div class="bg-info bg-opacity-10 rounded-circle p-3">
                            <i class="bi bi-hdd fs-3 text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4 mb-3">
            <div class="card border-success">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Permisos Otorgados</h6>
                            <h3 class="mb-0 text-success">@Model.TotalPermisos</h3>
                        </div>
                        <div class="bg-success bg-opacity-10 rounded-circle p-3">
                            <i class="bi bi-shield-check fs-3 text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mensajes de estado -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle me-2"></i>@TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>@TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- Botones de Acción -->
    <div class="row mb-4">
        <div class="col-12">
            <a href="/UploadVideo" class="btn btn-primary me-2">
                <i class="bi bi-upload me-1"></i>Subir Nuevo Video
            </a>
            <a href="/ManagePermissions" class="btn btn-outline-secondary me-2">
                <i class="bi bi-key me-1"></i>Gestionar Permisos
            </a>
            <a href="/IntegrityCheck" class="btn btn-outline-info">
                <i class="bi bi-shield-check me-1"></i>Verificar Integridad
            </a>
        </div>
    </div>

    <!-- Tabla de Videos -->
    <div class="card shadow-sm">
        <div class="card-header bg-white py-3">
            <h5 class="mb-0">
                <i class="bi bi-list-ul me-2"></i>Lista de Videos
            </h5>
        </div>
        <div class="card-body p-0">
            @if (Model.MyVideos.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th scope="col" style="width: 5%">#</th>
                                <th scope="col" style="width: 40%">Título</th>
                                <th scope="col" style="width: 15%" class="text-center">Tamaño</th>
                                <th scope="col" style="width: 20%" class="text-center">Fecha de Subida</th>
                                <th scope="col" style="width: 25%" class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < Model.MyVideos.Count; i++)
                            {
                                var video = Model.MyVideos[i];
                                <tr>
                                    <th scope="row">@(i + 1)</th>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-camera-video-fill text-primary me-2"></i>
                                            <div>
                                                <div class="fw-semibold">@video.TituloVideo</div>
                                                @if (!string.IsNullOrEmpty(video.Descripcion))
                                                {
                                                    <small class="text-muted">@(video.Descripcion.Length > 50 ? video.Descripcion.Substring(0, 50) + "..." : video.Descripcion)</small>
                                                }
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-light text-dark">
                                            @($"{video.TamañoArchivo / (1024.0 * 1024.0):F2} MB")
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <small>@video.FechaSubida.ToString("dd/MM/yyyy")</small>
                                        <br />
                                        <small class="text-muted">@video.FechaSubida.ToString("HH:mm")</small>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-info" 
                                                    title="Ver Video"
                                                    onclick="showVideoPlayer('@video.IdVideo', '@video.TituloVideo')">
                                                <i class="bi bi-play-circle"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-primary" 
                                                    title="Editar" 
                                                    onclick="window.location.href='/EditVideo?id=@video.IdVideo'">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-success" 
                                                    title="Gestionar Permisos"
                                                    onclick="window.location.href='/ManagePermissions?videoId=@video.IdVideo'">
                                                <i class="bi bi-key"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-danger" 
                                                    title="Eliminar"
                                                    onclick="confirmDelete('@video.IdVideo', '@video.TituloVideo')">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="bi bi-inbox display-1 text-muted"></i>
                    <h4 class="mt-3 text-muted">No tienes videos subidos</h4>
                    <p class="text-muted">Comienza subiendo tu primer video a la plataforma</p>
                    <a href="/UploadVideo" class="btn btn-primary mt-3">
                        <i class="bi bi-upload me-1"></i>Subir Video
                    </a>
                </div>
            }
        </div>
    </div>
</div>

<!-- Modal de Reproductor de Video -->
<div class="modal fade" id="videoPlayerModal" tabindex="-1" aria-labelledby="videoPlayerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="videoPlayerModalLabel">
                    <i class="bi bi-play-circle me-2"></i><span id="modalVideoTitle"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Columna del Reproductor -->
                    <div class="col-lg-8 mb-3">
                        <div class="ratio ratio-16x9 mb-3">
                            <iframe id="videoPlayerFrame" src="" frameborder="0" allowfullscreen></iframe>
                        </div>
                    </div>
                    
                    <!-- Columna de Usuarios con Acceso -->
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0">
                                    <i class="bi bi-people me-2"></i>Usuarios con Acceso
                                </h6>
                            </div>
                            <div class="card-body p-0">
                                <div id="usersWithAccessList" class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;">
                                    <div class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Cargando...</span>
                                        </div>
                                        <p class="mt-2 text-muted">Cargando usuarios...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmación de Eliminación -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="bi bi-exclamation-triangle me-2"></i>Confirmar Eliminación
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-2">¿Estás seguro de que deseas eliminar el video?</p>
                <p class="fw-bold mb-2" id="videoTitleToDelete"></p>
                <div class="alert alert-warning mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Atención:</strong> Esta acción no se puede deshacer. Se eliminarán también todos los permisos asociados.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Cancelar
                </button>
                <form id="deleteForm" method="post" style="display: inline;">
                    <input type="hidden" id="videoIdToDelete" name="videoId" />
                    <button type="submit" class="btn btn-danger" asp-page-handler="DeleteVideo">
                        <i class="bi bi-trash me-1"></i>Eliminar
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function confirmDelete(videoId, videoTitle) {
            document.getElementById('videoIdToDelete').value = videoId;
            document.getElementById('videoTitleToDelete').textContent = videoTitle;
            
            var deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            deleteModal.show();
        }

        async function showVideoPlayer(videoId, videoTitle) {
            // Establecer título del modal
            document.getElementById('modalVideoTitle').textContent = videoTitle;
            
            // Establecer URL del reproductor
            document.getElementById('videoPlayerFrame').src = '/VideoPlayer?id=' + videoId;
            
            // Mostrar modal
            var videoPlayerModal = new bootstrap.Modal(document.getElementById('videoPlayerModal'));
            videoPlayerModal.show();
            
            // Cargar lista de usuarios con acceso
            await loadUsersWithAccess(videoId);
        }

        async function loadUsersWithAccess(videoId) {
            const usersList = document.getElementById('usersWithAccessList');
            
            try {
                const response = await fetch(`/MyVideos?handler=VideoPermissions&videoId=${videoId}`);
                
                if (!response.ok) {
                    throw new Error('Error al cargar usuarios');
                }
                
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    let html = '';
                    data.data.forEach(permission => {
                        // Soportar tanto camelCase como PascalCase
                        const isActive = permission.estaActivo ?? permission.EstaActivo;
                        const badgeClass = isActive ? 'bg-success' : 'bg-danger';
                        const badgeText = isActive ? 'Activo' : 'Expirado';
                        const iconClass = isActive ? 'bi-check-circle-fill' : 'bi-x-circle-fill';
                        const nombreUsuario = permission.nombreUsuario ?? permission.NombreUsuario;
                        const fechaOtorgamiento = permission.fechaOtorgamiento ?? permission.FechaOtorgamiento;
                        const fechaExpiracion = permission.fechaExpiracion ?? permission.FechaExpiracion;
                        
                        html += `
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="bi bi-person-circle me-2"></i>
                                        <strong>${nombreUsuario}</strong>
                                    </div>
                                    <span class="badge ${badgeClass}">
                                        <i class="bi ${iconClass} me-1"></i>${badgeText}
                                    </span>
                                </div>
                                <small class="text-muted d-block mt-1">
                                    <i class="bi bi-calendar me-1"></i>
                                    ${new Date(fechaOtorgamiento).toLocaleDateString('es-ES')}
                                </small>
                                ${isActive && fechaExpiracion ? `
                                    <small class="text-muted d-block">
                                        <i class="bi bi-clock me-1"></i>
                                        Expira: ${new Date(fechaExpiracion).toLocaleDateString('es-ES')}
                                    </small>
                                ` : ''}
                            </div>
                        `;
                    });
                    usersList.innerHTML = html;
                } else {
                    usersList.innerHTML = `
                        <div class="text-center py-4">
                            <i class="bi bi-inbox display-4 text-muted"></i>
                            <p class="mt-2 text-muted">No hay usuarios con acceso a este video</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error:', error);
                usersList.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-exclamation-triangle display-4 text-danger"></i>
                        <p class="mt-2 text-danger">Error al cargar usuarios</p>
                    </div>
                `;
            }
        }

        // Limpiar iframe cuando se cierra el modal
        document.getElementById('videoPlayerModal').addEventListener('hidden.bs.modal', function () {
            document.getElementById('videoPlayerFrame').src = '';
        });
    </script>
}
